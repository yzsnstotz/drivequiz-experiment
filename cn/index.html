<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>zalem.app</title>
  <style>
    /* ---------------------------
       保留原有的视觉效果与布局
       --------------------------- */
    body {
      overflow-x: hidden;  /* 禁止水平滚动 */
      position: relative;  /* 防止因某些布局引起的位移 */
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #e9f5ff;
      box-sizing: border-box;
    }

    h1 {
      text-align: center;
      color: #fff;
      background-color: #007BFF;
      padding: 15px 0;
      margin: 0;
      cursor: pointer; /* 鼠标悬停时显示为手型 */
    }

    /* 域名、口号、标题的排版 */
    h1 .domain {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    h1 .title {
      font-size: 15px; /* 缩小字体大小 */
    }

    h2 {
      text-align: center;
      color: #333;
      margin: 15px 0;
      font-size: 20px;
    }

    #container,
    #quiz-container,
    #result-container,
    #mistake-review-container,
    /* #current-mistakes-container,  注: 仍保留, 只是不在startMistakeQuiz里调用 */
    #console-logs-container,
    #update-logs-container,
    #function-intro-container,
    #summary-container,
    #battle-mode-selection-container,
    #favorites-container {
      margin: 30px auto;
      max-width: 800px;
      border: 2px solid #ddd;
      border-radius: 10px;
      background-color: #fff;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 20px;
      display: none; /* 默认隐藏容器 */
    }

    #container,
    #battle-mode-selection-container {
      display: block; /* 主页 和 大乱斗选择容器默认显示 */
    }

    /* 菜单分类按钮布局 */
    #category-selection {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    #category-selection button {
      padding: 10px 15px;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    #category-selection button:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }

    #sheet-selection {
      display: none;
    }

    #info {
      text-align: center;
      margin-top: 20px;
      color: #555;
      font-size: 14px;
      line-height: 1.6;
    }
    #info .top-buttons,
    #info .battle-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    #info .bottom-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    #info button {
      padding: 10px 15px;
      background: #4DAFFF;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    #info button:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }

    /* 三大复选框布局 */
    #random-option {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    #random-option label {
      display: inline-flex;
      align-items: center;
      cursor: pointer;
      padding: 6px 10px;
      border: 1px solid #007BFF;
      border-radius: 5px;
      background: #fff;
      font-size: 14px;
    }
    #random-option input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 6px;
    }

    /* 考题与选项布局 */
    #question {
      font-size: 18px;
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
      background-color: #fdf8e4;
      text-align: center;
      min-height: 50px; 
      line-height: 1.4;
      white-space: pre-wrap;
    }
    #image {
      margin-bottom: 20px;
      border: 2px solid #ccc;
      border-radius: 10px;
      background-color: #f0f8ff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 50px; 
      padding: 10px;
    }
    #image img {
      max-width: 100%;
      max-height: 150px;
      object-fit: contain;
    }
    .options,
    .controls {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
    }
    .options button,
    .controls button {
      flex: 1;
      margin: 0 5px;
    }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease-in-out;
      text-align: center;
      white-space: nowrap;
    }
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }

    /* 正确/错误按钮及高亮 */
    .correct {
      background: #28a745; /* 绿色 */
      color: #fff;
      border: 2px solid #fff;
      position: relative;
    }
    .correct.highlight {
      background: #1e7e34;
      box-shadow: 0 0 10px #1e7e34;
    }
    .wrong {
      background: #dc3545; /* 红色 */
      color: #fff;
      border: 2px solid #fff;
      position: relative;
    }
    .wrong.highlight {
      background: #c82333;
      box-shadow: 0 0 10px #c82333;
    }
    .wrong span {
      text-shadow: -1px 0 #fff, 0 1px #fff, 1px 0 #fff, 0 -1px #fff;
    }

    /* 收藏按钮（星标） */
    #favorite-btn {
      background: #ccc;
      color: #000;
      flex: 0 1 auto;
      max-width: 70px;
      margin-left: 5px;
      font-size: 18px;
    }
    #favorite-btn.favorited {
      background: #ffeb3b; /* 高亮 */
      color: #d9534f;
    }

    /* 展示正确答案/解说 */
    #answer-display {
      font-size: 18px;
      font-weight: bold;
      color: #FF4D4D;
      margin-top: 10px;
      text-align: center;
      white-space: pre-wrap;
    }

    /* 题目余量与计时 */
    #remaining-questions {
      text-align: center; 
      margin-top: 20px;
      font-size: 16px;
      color: #333;
    }
    #timer {
      text-align: center;
      font-size: 18px;
      margin-top: 10px;
      color: #333;
    }

    /* 考试结果样式 */
    #score.score-excellent {
      color: #28a745;
      font-size: 32px;
      font-weight: bold;
    }
    #score.score-good {
      color: #ffc107;
      font-size: 32px;
      font-weight: bold;
    }
    #score.score-bad {
      color: #dc3545;
      font-size: 32px;
      font-weight: bold;
    }
    .progress-bar-container {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 25px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-bar {
      height: 25px;
      width: 0%;
      background-color: #28a745;
      text-align: center;
      line-height: 25px;
      color: white;
      border-radius: 25px;
      transition: width 0.5s ease-in-out;
      font-size: 16px;
      font-weight: bold;
    }

    /* 大乱斗弹窗样式 */
    #battle-mode-selection-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #battle-mode-selection {
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      max-height: 80%;
      overflow-y: auto;
    }
    #battle-mode-selection .sheet-option {
      margin-bottom: 10px;
    }

    /* 初始消息区域 */
    #initial-message {
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
      color: #856404;
      font-size: 16px;
      line-height: 1.5;
    }
    #initial-message p {
      margin: 10px 0;
    }
    #initial-message img {
      display: block;
      margin: 20px auto 10px auto;
      max-width: 200px;
      cursor: pointer;
    }

    /* 错题、收藏、日志等容器 */
    #mistake-questions > div {
      border-bottom: 1px solid #ccc;
      margin-bottom: 15px;
      padding-bottom: 15px;
      line-height: 1.4;
    }
    #console-logs-content table {
      width:100%;
      border-collapse: collapse;
      margin-top:20px;
    }
    #console-logs-content table,
    #console-logs-content th,
    #console-logs-content td {
      border:1px solid #ccc;
      padding:5px;
      text-align:left;
      font-size:14px;
    }
    #console-logs-content th {
      background: #f9f9f9;
    }

    /* 更新日志 & 功能介绍 & 汇总表现的容器 */
    #update-logs-list,
    #summary-content {
      font-size:14px;
      line-height:1.6;
    }
    .summary-sheet {
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 15px;
      background-color: #f9f9f9;
    }
    .summary-sheet h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
      text-align: left;
    }
    .summary-sheet table {
      width: auto;
      min-width: 600px;
      overflow-x: auto;
      display: block;
      white-space: nowrap;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .summary-sheet th,
    .summary-sheet td {
      border: 1px solid #ccc;
      padding: 5px 8px;
      text-align: center;
      font-size: 13px;
    }
    .summary-sheet th {
      background-color: #f1f1f1;
      font-weight: normal;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <!-- 顶部标题，点击可返回首页 -->
  <h1 onclick="resetQuiz()">
    <div class="domain">zalem.app</div>
    <div class="title">道路千万条，安全第一条；行车不规范，亲人泪两行！</div>
  </h1>

  <!-- 主容器：分类选择 & 复选框 -->
  <div id="container">
    <h2>请选择套题类别</h2>
    <div id="random-option">
      <label>
        <input type="checkbox" id="random-checkbox"> 随机题序
      </label>
      <label>
        <input type="checkbox" id="autonext-checkbox"> 自动翻题
      </label>
      <label>
        <input type="checkbox" id="show-japanese-checkbox"> 显示日语
      </label>
    </div>

    <!-- 类别按钮区域 -->
    <div id="category-selection">加载中...</div>

    <!-- 原先 sheet-selection 隐藏，不再使用 -->
    <div id="sheet-selection" style="display:none;">加载中...</div>
    
    <!-- 底部按钮区 -->
    <div id="info">
      <div class="top-buttons">
        <button onclick="showSummary()" style="background: #17a2b8;">汇总表现</button>
        <button id="continue-exam-btn" style="display:none;" onclick="continueExam()">继续考试</button>
      </div>
      <div class="bottom-buttons">
        <button onclick="showFunctionIntro()">功能介绍</button>
        <button onclick="showUpdateLogs()">更新日志</button>
        <!-- 新增：下载本地log.txt按钮 -->
        <button onclick="viewConsoleLogs()">控制台</button>
        <button onclick="clearAllHistory()">清除历史</button>
      </div>
    </div>

    <!-- 留言区域 -->
    <div style="height: 20px;"></div>
    <div id="initial-message">
      <p>加载中...</p>
    </div>
  </div>

  <!-- 大乱斗模式选择弹层 -->
  <div id="battle-mode-selection-container">
    <div id="battle-mode-selection">
      <h3>选择参与大乱斗的套题</h3>
      <div id="battle-sheet-selection">
        <!-- 复选框列表由脚本动态生成 -->
      </div>
      <button onclick="startBattleMode()">开始大乱斗</button>
      <button onclick="closeBattleModeSelection()">取消</button>
    </div>
  </div>

  <!-- 考试容器 -->
  <div id="quiz-container" style="display: none;">
    <h2 id="sheet-name">加载中...</h2>
    <div id="question">加载中...</div>
    <div id="image" style="display:none;"></div>
    <div class="options">
      <button id="btn-correct" class="correct" onclick="selectAnswer('⭕')">
        <span>⭕</span> 正确
      </button>
      <button id="btn-wrong" class="wrong" onclick="selectAnswer('❌')">
        <span>❌</span> 错误
      </button>
    </div>
    <div class="controls">
      <button onclick="previousQuestion()">上一题</button>
      <button onclick="nextQuestion()">下一题</button>
      <button id="favorite-btn" onclick="toggleFavorite()">⭐</button>
    </div>
    <div id="remaining-questions"></div>
    <div id="timer">时间：00分钟00秒</div>
    <div id="answer-display"></div>
    <div style="text-align: center; margin-top: 20px;">
      <button onclick="toggleAnswer()">显示/隐藏 正确答案</button>
      <button onclick="pauseExam()">暂停退出</button>
      <button onclick="submitQuiz()">交卷</button>
    </div>
  </div>

  <!-- 考试结果容器 -->
  <div id="result-container" style="display: none;">
    <h2>考试结束</h2>
    <div style="text-align: center;">
      <p id="score" style="font-size: 32px; font-weight: bold;"></p>
      <p id="mistake-count" style="font-size: 20px; color: #dc3545;"></p>
      <p id="correct-count" style="font-size: 20px; color: #28a745;"></p>
      <p id="unanswered-count" style="font-size: 20px; color: #ffc107;"></p>
      <p id="completion-status"></p>
      <div class="progress-bar-container">
        <div class="progress-bar" id="progress-bar">0%</div>
      </div>
    </div>
    <button onclick="resetQuiz()">再来一套</button>
    <button onclick="viewMistakes()">查看本次错题</button>
  </div>

  <!-- 本次错题列表（仅供考试结束后查看，不在“错题复习”模式中出现） -->
  <div id="current-mistakes-container" style="display: none;">
    <h2>本次错题</h2>
    <div id="current-mistakes-list"></div>
    <button onclick="showScore()">返回评分</button>
    <button onclick="resetQuiz()">返回首页</button>
  </div>

  <!-- 错题复习容器（去掉“本次错题”板块） -->
  <div id="mistake-review-container"></div>

  <!-- 我的收藏容器 -->
  <div id="favorites-container">
    <h2>我的收藏</h2>
    <div style="text-align:center;">
      <button onclick="startFavoritesQuiz()">开始收藏题测试</button>
      <button onclick="resetQuiz()">返回首页</button>
    </div>
  </div>

  <!-- 控制台日志 -->
  <div id="console-logs-container">
    <h2>控制台</h2>
    <div id="console-logs-content">加载中...</div>
    <button onclick="resetQuiz()">返回首页</button>
  </div>

  <!-- 更新日志 -->
  <div id="update-logs-container">
    <h2>更新日志</h2>
    <div id="update-logs-list">
      <p>加载中...</p>
    </div>
    <button onclick="resetQuiz()">返回首页</button>
  </div>

  <!-- 功能介绍 -->
  <div id="function-intro-container">
    <h2>功能介绍</h2>
    <div id="function-intro-content">
      <p>加载中...</p>
    </div>
    <button onclick="resetQuiz()">返回首页</button>
  </div>

  <!-- 汇总表现 -->
  <div id="summary-container">
    <h2>汇总表现</h2>
    <div id="summary-content">加载中...</div>
    <button onclick="resetQuiz()">返回首页</button>
  </div>

  <script>
    /**************************************************
     * [1] 系统信息表 - 用于动态获取套题配置、日志记录等
     **************************************************/
    const SYSTEM_SPREADSHEET_ID = "1bkTNZje3ehMPn2-PNH-yLT1kPpRvs_HAfiYuPg2jA6w";
    const SYSTEM_API_KEY = "AIzaSyApEcu1zgGEexoS_diT6PkCPQDWkX5Adhk";
    // 若系统信息表中“系统log”工作表叫别的名称，请改这里
    const LOG_SHEET_NAME = "系统log";  

    /**************************************************
     * 全局状态
     **************************************************/
    let logs = []; // 记录事件/错误/访问等(下载或上传到Sheet)
    let userLocation = "未知地点";
    let categoriesData = [];  // “考题管理”读取到的所有套题配置
    let sheetListForBattle = []; // 大乱斗(CN)列表

    // 当前考试相关
    let questions = [];
    let currentQuestionIndex = 0;
    let currentSheetName = "";
    let userAnswers = [];
    let answerVisible = false;
    let mistakeQuestions = [];
    let favorites = {};

    let isBattleMode = false;
    let isMistakeMode = false;
    let isFavoritesMode = false;

    // 计时器
    let quizStartTime = null;
    let quizEndTime = null;
    let timerInterval = null;
    let elapsedTime = 0;

    // 三大复选框
    let randomOrder = loadRandomOrderSetting();
    let autoNext = loadAutoNextSetting();
    let showJapanese = loadShowJapaneseSetting();


    /***********************************************
     * DOMContentLoaded入口
     ***********************************************/
    document.addEventListener('DOMContentLoaded', async () => {
      // 复选框初始
      document.getElementById('random-checkbox').checked = randomOrder;
      document.getElementById('random-checkbox').addEventListener('change',()=>{
        randomOrder = document.getElementById('random-checkbox').checked;
        saveRandomOrderSetting(randomOrder);
        logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'toggle randomOrder', randomOrder}});
      });
      document.getElementById('autonext-checkbox').checked = autoNext;
      document.getElementById('autonext-checkbox').addEventListener('change',()=>{
        autoNext = document.getElementById('autonext-checkbox').checked;
        saveAutoNextSetting(autoNext);
        logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'toggle autoNext', autoNext}});
      });
      document.getElementById('show-japanese-checkbox').checked = showJapanese;
      document.getElementById('show-japanese-checkbox').addEventListener('change',()=>{
        showJapanese = document.getElementById('show-japanese-checkbox').checked;
        saveShowJapaneseSetting(showJapanese);
        logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'toggle showJapanese', showJapanese}});
        // 若正在考试中，可更新题目显示
        if(document.getElementById('quiz-container').style.display==='block'){
          loadQuestion();
        }
      });

      // 加载收藏
      favorites = loadFavorites();
      logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'loaded favorites', count:Object.keys(favorites).length}});

      // 检测是否有未完成考试
      if(loadCurrentExam()) {
        document.getElementById('continue-exam-btn').style.display='inline-block';
      }

      // 获取IP & 地理位置 => 写log
      await getClientIPAndLogAccess();

      // 加载一些初始信息
      loadInitialMessages();
      loadUpdateLogs();
      loadFunctionIntro();

      // 从系统表中获取所有套题配置信息
      await fetchCategoriesData();

      // 渲染左侧分类按钮
      renderCategoryButtons();

      // 大乱斗候选 = CN语言的套题
      sheetListForBattle = categoriesData.filter(x => x.lang==="CN");
    });

    window.addEventListener('beforeunload',()=>{
      // 若正在考试，离开时保存进度
      if(document.getElementById('quiz-container').style.display==='block'){
        saveCurrentExam();
      }
    });

    /********************************************
     *  1) 动态获取“考题管理”Sheet数据
     ********************************************/
    async function fetchCategoriesData(){
      try{
        // A:G -> A=内部名称, B=语言, C=类别, D=对外展示Sheet名, E=spreadId, F=apiKey, G=内部配对码
        const url= `https://sheets.googleapis.com/v4/spreadsheets/${SYSTEM_SPREADSHEET_ID}/values/考题管理!A:G?key=${SYSTEM_API_KEY}`;
        const r= await fetch(url);
        if(!r.ok){
          throw new Error("fetchCategoriesData request failed");
        }
        const dat= await r.json();
        if(!dat.values || dat.values.length<2) {
          throw new Error("考题管理Sheet数据为空");
        }
        const rows = dat.values.slice(1);
        categoriesData = rows.map(row=>{
          return {
            internalName: (row[0]||"").trim(),   // A
            lang: (row[1]||"").trim(),          // B
            categoryName: (row[2]||"").trim(),  // C
            sheetName: (row[3]||"").trim(),     // D (对外展示Sheet名)
            spreadId: (row[4]||"").trim(),      // E
            apiKey: (row[5]||"").trim(),        // F
            internalCode: (row[6]||"").trim()   // G
          };
        });
        logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'fetchCategoriesData success', count:categoriesData.length}});
      }catch(e){
        console.error(e);
        logs.push({type:'error', time:new Date().toLocaleString(), location:userLocation, detail:{message:'fetchCategoriesData error', error:e}});
        document.getElementById('category-selection').innerHTML="<p>加载类别异常</p>";
      }
    }

    /********************************************
     *  2) 渲染类别按钮
     ********************************************/
    function renderCategoryButtons(){
      let mapCat={}; 
      // 把 lang=CN 的条目根据 categoryName 分组
      categoriesData.forEach(item=>{
        if(item.lang==="CN"){
          if(!mapCat[item.categoryName]){
            mapCat[item.categoryName]=[];
          }
          mapCat[item.categoryName].push(item);
        }
      });

      // 将大乱斗、我的收藏、错题复习 做为附加按钮
      let finalArr = Object.keys(mapCat).map(k=>{
        return {
          internalName: k,
          displayName: k,
          sheetList: mapCat[k]
        };
      });
      finalArr.push({internalName:"battleMode", displayName:"大乱斗", sheetList:[]});
      finalArr.push({internalName:"favoritesMode", displayName:"我的收藏", sheetList:[]});
      finalArr.push({internalName:"mistakeMode", displayName:"错题复习", sheetList:[]});

      const cont = document.getElementById('category-selection');
      cont.innerHTML="";
      finalArr.forEach(cat=>{
        const btn = document.createElement('button');
        btn.textContent= cat.displayName;
        if(cat.internalName==="battleMode") {
          btn.style.backgroundColor="#6f42c1";
        } else if(cat.internalName==="favoritesMode") {
          btn.style.backgroundColor="#f0ad4e";
        } else if(cat.internalName==="mistakeMode") {
          btn.style.backgroundColor="#dc3545";
        } else {
          btn.style.backgroundColor="#007BFF";
        }
        btn.onclick=()=> onCategoryClick(cat);
        cont.appendChild(btn);
      });
    }

    function onCategoryClick(cat){
      logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'onCategoryClick', cat}});
      if(cat.internalName==="battleMode"){
        openBattleModeSelection();
        return;
      }
      if(cat.internalName==="favoritesMode"){
        showFavorites();
        return;
      }
      if(cat.internalName==="mistakeMode"){
        startMistakeQuiz();
        return;
      }
      // 普通类别 => 显示套题按钮
      showSheetButtons(cat.sheetList);
    }

    function showSheetButtons(sheetArr){
      const cont = document.getElementById('category-selection');
      cont.innerHTML="";
      if(!sheetArr || sheetArr.length===0){
        cont.innerHTML="<p>该类别暂无套题</p>";
        return;
      }
      sheetArr.forEach(sobj=>{
        const btn = document.createElement('button');
        // D 列 => sheetName
        btn.textContent= sobj.sheetName||"[无标题]";
        btn.style.backgroundColor="#17a2b8";
        btn.onclick=()=>{
          logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'click sub-sheet', sheetName:sobj.sheetName}});
          // fetch CN -> sobj.spreadId + sobj.sheetName
          fetchQuestionsCN(sobj);
        };
        cont.appendChild(btn);
      });

      // 返回上一级
      const backBtn= document.createElement('button');
      backBtn.textContent="返回上一级";
      backBtn.style.backgroundColor="#aaa";
      backBtn.onclick= renderCategoryButtons;
      cont.appendChild(backBtn);
    }

    /********************************************
     *  3) 动态获取题目 (CN + 日语合并)
     ********************************************/
    async function fetchQuestionsCN(sobj){
      // sobj => { internalName, lang, categoryName, sheetName, spreadId, apiKey, internalCode }
      try{
        document.getElementById('sheet-name').textContent="加载中...";
        document.getElementById('question').textContent="加载中...";
        let urlCN= `https://sheets.googleapis.com/v4/spreadsheets/${sobj.spreadId}/values/${encodeURIComponent(sobj.sheetName)}?key=${sobj.apiKey}`;
        logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'fetchQuestionsCN - start', urlCN}});
        
        let resp= await fetch(urlCN);
        if(!resp.ok){
          throw new Error("fetch CN question failed: " + sobj.sheetName);
        }
        let d= await resp.json();
        if(!d.values || d.values.length<1){
          throw new Error("fetch CN question empty: " + sobj.sheetName);
        }
        let cnQuestions = processSheetData(d.values);

        // 若显示日语 => 找到 lang="JP" && internalCode与这个 sobj.internalCode 一致的那一条
        if(showJapanese){
          let jpItem= categoriesData.find(x=> x.lang==="JP" && x.internalCode=== sobj.internalCode);
          if(jpItem){
            try{
              let urlJP= `https://sheets.googleapis.com/v4/spreadsheets/${jpItem.spreadId}/values/${encodeURIComponent(jpItem.sheetName)}?key=${jpItem.apiKey}`;
              logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'fetchQuestionsJP - start', urlJP}});
              let jr= await fetch(urlJP);
              if(jr.ok){
                let jd= await jr.json();
                if(jd.values && jd.values.length>0){
                  let jpArr= processSheetData(jd.values, true);
                  logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'JP row count', cnCount:cnQuestions.length, jpCount:jpArr.length}});
                  // 合并JP
                  cnQuestions.forEach((q, idx)=>{
                    if(jpArr[idx]){
                      q.jpQuestion= jpArr[idx].question;
                      q.jpExplanation= jpArr[idx].explanation;
                    }
                  });
                } else {
                  logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'No JP rows found in sheet', sheet:jpItem.sheetName}});
                }
              } else {
                logs.push({type:'error', time:new Date().toLocaleString(), location:userLocation, detail:{message:'fetch JP request not ok', sheetName:jpItem.sheetName}});
              }
            }catch(e2){
              logs.push({type:'error', time:new Date().toLocaleString(), location:userLocation, detail:{message:'fetchQuestionsJP exception', error:e2}});
            }
          } else {
            logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'no JP item found for internalCode', code:sobj.internalCode}});
          }
        }

        currentSheetName= sobj.sheetName; // 显示用(中文套题名称)
        questions= randomOrder ? shuffle(cnQuestions) : cnQuestions;
        isBattleMode=false; isMistakeMode=false; isFavoritesMode=false;

        // 在题目中保存后续要用的信息
        questions.forEach(q=>{
          q.spreadId= sobj.spreadId;
          q.apiKey= sobj.apiKey;
          q.sheetName= sobj.sheetName;       // CN对外名
          q.internalCode= sobj.internalCode; // 用于中日匹配
        });

        startQuiz();
      }catch(e){
        console.error(e);
        logs.push({type:'error', time:new Date().toLocaleString(), location:userLocation, detail:{message:'fetchQuestionsCN exception', error:e}});
        document.getElementById('sheet-name').textContent=`加载套题[${sobj.sheetName}]失败`;
        document.getElementById('question').textContent="";
      }
    }

    function processSheetData(values, isJP=false){
      // 假设表格4列： [题目, 图片, 答案(o/x), 解说]
      return values.map((row, idx)=>{
        let q = (row[0]||"").trim().replace(/\u200B/g,'');
        let img= (row[1]||"").trim();
        let ans= ((row[2]||"").trim().toLowerCase()==='o') ? '⭕':'❌';
        let exp= (row[3]||"").trim();
        return {
          rowIndex: idx,
          question: isJP ? (q||"") : (q||"无题目"),
          image: img,
          answer: ans,
          explanation: exp
        };
      }).filter(q=> isJP || q.question!=="无题目");
    }

    function shuffle(arr){
      for(let i=arr.length-1; i>0; i--){
        let j= Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]]=[arr[j], arr[i]];
      }
      return arr;
    }

    /********************************************
     * 4) 开始考试
     ********************************************/
    function startQuiz(){
      logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'startQuiz', total:questions.length, sheetName:currentSheetName}});
      currentQuestionIndex=0;
      userAnswers=[];
      answerVisible=false;
      mistakeQuestions=[];
      elapsedTime=0;
      clearCurrentExam();

      document.getElementById('container').style.display='none';
      document.getElementById('quiz-container').style.display='block';
      document.getElementById('sheet-name').textContent=`当前套题：${currentSheetName}`;
      loadQuestion();
      startTimer();
    }

    function loadQuestion(){
      const q= questions[currentQuestionIndex];
      const questionElem= document.getElementById('question');
      const imageContainer= document.getElementById('image');
      const favoriteBtn= document.getElementById('favorite-btn');
      document.getElementById('answer-display').textContent="";

      if(!q) return;
      let text= q.question;
      if(showJapanese && q.jpQuestion){
        text+= "\n-----\n"+ q.jpQuestion;
      }
      questionElem.textContent= text;

      // 图片
      imageContainer.style.display='none';
      imageContainer.innerHTML="";
      if(q.image){
        imageContainer.style.display='flex';
        imageContainer.textContent="加载中...";
        let img= new Image();
        img.src= q.image;
        img.onload=()=>{
          imageContainer.innerHTML="";
          imageContainer.appendChild(img);
        };
        img.onerror=()=>{
          imageContainer.style.display='none';
          imageContainer.innerHTML="";
        };
      }

      // 高亮已选
      resetButtonHighlight();
      let ans= userAnswers[currentQuestionIndex];
      if(ans==="⭕") document.getElementById('btn-correct').classList.add('highlight');
      if(ans==="❌") document.getElementById('btn-wrong').classList.add('highlight');

      // 剩余题数
      document.getElementById('remaining-questions').textContent=`剩余题数：${questions.length - currentQuestionIndex -1}`;

      // 收藏状态
      favoriteBtn.classList.remove('favorited');
      let favKey= getFavoriteKey(q);
      if(favorites[favKey]){
        favoriteBtn.classList.add('favorited');
      }

      saveCurrentExam();
    }
    function resetButtonHighlight(){
      document.getElementById('btn-correct').classList.remove('highlight');
      document.getElementById('btn-wrong').classList.remove('highlight');
    }
    function selectAnswer(ans){
      userAnswers[currentQuestionIndex]= ans;
      resetButtonHighlight();
      if(ans==="⭕") document.getElementById('btn-correct').classList.add('highlight');
      if(ans==="❌") document.getElementById('btn-wrong').classList.add('highlight');

      saveCurrentExam();

      if(autoNext){
        setTimeout(()=>{
          if(currentQuestionIndex<questions.length-1){
            currentQuestionIndex++;
            loadQuestion();
          } else{
            alert("已到最后一题，请交卷");
          }
        },300);
        if(currentQuestionIndex===questions.length-1){
          setTimeout(()=>{
            submitQuiz();
          },500);
        }
      }
    }
    function toggleAnswer(){
      const q= questions[currentQuestionIndex];
      if(!q) return;
      const answerDisp= document.getElementById('answer-display');
      if(answerVisible){
        answerDisp.textContent="";
      } else{
        let txt= `正确答案：${q.answer}`;
        if(q.explanation){
          txt+= `\n解说：${q.explanation}`;
        }
        if(showJapanese && q.jpExplanation){
          txt+= `\n-----\n【日文解说】\n${q.jpExplanation}`;
        }
        answerDisp.textContent= txt;
      }
      answerVisible=!answerVisible;
    }
    function nextQuestion(){
      if(currentQuestionIndex<questions.length-1){
        currentQuestionIndex++;
        loadQuestion();
      } else{
        alert("已是最后一题");
      }
    }
    function previousQuestion(){
      if(currentQuestionIndex>0){
        currentQuestionIndex--;
        loadQuestion();
      }
    }

    /********************************************
     * 5) 收藏
     ********************************************/
    function getFavoriteKey(q){
      // [spreadId, rowIndex, sheetName, question]
      return [q.spreadId, q.rowIndex, q.sheetName, q.question].join("||");
    }
    function toggleFavorite(){
      const q= questions[currentQuestionIndex];
      let favKey= getFavoriteKey(q);
      const btn= document.getElementById('favorite-btn');

      if(favorites[favKey]){
        // 取消收藏
        delete favorites[favKey];
        btn.classList.remove('favorited');
        logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'remove favorite', favKey}});
      } else {
        // 收藏
        favorites[favKey]={
          rowIndex: q.rowIndex,
          question: q.question,
          image: q.image,
          answer: q.answer,
          explanation: q.explanation,
          spreadId: q.spreadId,
          apiKey: q.apiKey,
          sheetName: q.sheetName,
          internalCode: q.internalCode||"",
          jpQuestion: q.jpQuestion||"",
          jpExplanation: q.jpExplanation||""
        };
        btn.classList.add('favorited');
        logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'add favorite', favKey}});
      }
      saveFavorites(favorites);
    }

    function showFavorites(){
      logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'showFavorites'}});
      hideAll();
      document.getElementById('favorites-container').style.display='block';
    }

    async function startFavoritesQuiz(){
      logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'startFavoritesQuiz'}});
      let favKeys= Object.keys(favorites);
      if(favKeys.length===0){
        alert("暂无收藏题目");
        return;
      }
      isFavoritesMode=true; isBattleMode=false; isMistakeMode=false;
      currentSheetName="我的收藏";

      // 根据 spreadId+sheetName 分组
      let groupMap={};
      favKeys.forEach(k=>{
        let item= favorites[k];
        let gk= item.spreadId+"||"+item.sheetName;
        if(!groupMap[gk]) groupMap[gk]=[];
        groupMap[gk].push(item);
      });

      let allFavs=[];
      for(const gk in groupMap){
        const [spId, sName]= gk.split("||");
        if(!spId || !sName){
          logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'favorite missing spId or sName', gk}});
          continue;
        }
        let baseQArr=[];
        try{
          let baseUrl= `https://sheets.googleapis.com/v4/spreadsheets/${spId}/values/${encodeURIComponent(sName)}?key=${groupMap[gk][0].apiKey}`;
          logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'fetch favorites CN', baseUrl}});
          let r= await fetch(baseUrl);
          if(r.ok){
            let d=await r.json();
            if(d.values && d.values.length>0){
              baseQArr= processSheetData(d.values);
            }
          }
        }catch(e){
          logs.push({type:'error', time:new Date().toLocaleString(), location:userLocation, detail:{message:'fetch favorites CN error', error:e}});
        }

        // 若显示日语
        if(showJapanese){
          // 取 internalCode => 再在 categoriesData 找 JP 行
          let internalCode= groupMap[gk][0].internalCode||"";
          if(internalCode){
            let jpRow= categoriesData.find(x=> x.lang==="JP" && x.internalCode=== internalCode && x.spreadId=== spId);
            if(jpRow){
              try{
                let jpUrl= `https://sheets.googleapis.com/v4/spreadsheets/${jpRow.spreadId}/values/${encodeURIComponent(jpRow.sheetName)}?key=${jpRow.apiKey}`;
                logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'fetch favorites JP', jpUrl}});
                let jr= await fetch(jpUrl);
                if(jr.ok){
                  let jd= await jr.json();
                  if(jd.values && jd.values.length>0){
                    let jpArr= processSheetData(jd.values,true);
                    baseQArr.forEach((qq,idx)=>{
                      if(jpArr[idx]){
                        qq.jpQuestion= jpArr[idx].question;
                        qq.jpExplanation= jpArr[idx].explanation;
                      }
                    });
                  }
                }
              }catch(e2){
                logs.push({type:'error', time:new Date().toLocaleString(), location:userLocation, detail:{message:'fetch favorites JP error', error:e2}});
              }
            }
          }
        }

        // 挑出收藏行
        let favSet=new Set();
        groupMap[gk].forEach(fItem=>{
          let rowIdx= fItem.rowIndex;
          let found= baseQArr[rowIdx];
          let key= spId+"_"+rowIdx; 
          if(!favSet.has(key)){
            favSet.add(key);
            if(found){
              allFavs.push({
                ...found,
                spreadId: spId,
                apiKey: fItem.apiKey,
                sheetName: sName, 
                internalCode: fItem.internalCode||"",
                jpQuestion: found.jpQuestion||"",
                jpExplanation: found.jpExplanation||""
              });
            } else{
              // 在源表里找不到就直接用fItem
              allFavs.push({...fItem});
            }
          }
        });
      }
      if(allFavs.length===0){
        alert("收藏数据为空");
        return;
      }
      questions= randomOrder ? shuffle(allFavs) : allFavs;
      currentQuestionIndex=0;
      userAnswers=[];
      answerVisible=false;
      mistakeQuestions=[];
      elapsedTime=0;
      clearCurrentExam();

      document.getElementById('favorites-container').style.display='none';
      document.getElementById('quiz-container').style.display='block';
      document.getElementById('sheet-name').textContent="收藏题单元测试";
      loadQuestion();
      startTimer();
    }

    /********************************************
     * 6) 大乱斗
     ********************************************/
    function openBattleModeSelection(){
      logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'openBattleModeSelection'}});
      document.getElementById('battle-mode-selection-container').style.display='flex';
      const c= document.getElementById('battle-sheet-selection');
      c.innerHTML="";
      let used= new Set();
      sheetListForBattle.forEach(s=>{
        let uk= s.sheetName+"||"+s.spreadId;
        if(!used.has(uk)){
          used.add(uk);
          const div= document.createElement('div');
          div.classList.add('sheet-option');
          div.innerHTML=`
            <label>
              <input type="checkbox" value="${s.sheetName}||${s.spreadId}||${s.apiKey}||${s.internalCode}">
              ${s.sheetName}
            </label>
          `;
          c.appendChild(div);
        }
      });
    }
    function closeBattleModeSelection(){
      logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'closeBattleModeSelection'}});
      document.getElementById('battle-mode-selection-container').style.display='none';
    }
    async function startBattleMode(){
      logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'startBattleMode'}});
      const selected= Array.from(document.querySelectorAll('#battle-sheet-selection input[type="checkbox"]:checked'))
        .map(cb=> cb.value);
      if(selected.length===0){
        alert("请选择至少一个套题进行大乱斗！");
        return;
      }
      let num= prompt("请输入大乱斗题数(10-500)：","50");
      if(num===null) return;
      num= parseInt(num);
      if(isNaN(num)|| num<10 || num>500){
        alert("请输入10~500的数字");
        return;
      }
      closeBattleModeSelection();

      let allQ=[];
      for(const sel of selected){
        const [sName, sId, sApi, iCode]= sel.split("||");
        let baseQArr=[];
        try{
          let url= `https://sheets.googleapis.com/v4/spreadsheets/${sId}/values/${encodeURIComponent(sName)}?key=${sApi}`;
          logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'battle fetch CN', url}});
          let r= await fetch(url);
          if(r.ok){
            let d= await r.json();
            if(d.values && d.values.length>0){
              baseQArr= processSheetData(d.values);
            }
          }
        }catch(e){}
        // 若显示日语
        if(showJapanese){
          let jpItem= categoriesData.find(x=> x.lang==="JP" && x.internalCode===iCode && x.spreadId===sId);
          if(jpItem){
            try{
              let jurl= `https://sheets.googleapis.com/v4/spreadsheets/${jpItem.spreadId}/values/${encodeURIComponent(jpItem.sheetName)}?key=${jpItem.apiKey}`;
              logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'battle fetch JP', jurl}});
              let jr= await fetch(jurl);
              if(jr.ok){
                let jd= await jr.json();
                if(jd.values && jd.values.length>0){
                  let jpArr= processSheetData(jd.values,true);
                  baseQArr.forEach((qq,idx)=>{
                    if(jpArr[idx]){
                      qq.jpQuestion= jpArr[idx].question;
                      qq.jpExplanation= jpArr[idx].explanation;
                    }
                  });
                }
              }
            }catch(e2){}
          }
        }
        // 标记spreadId/apiKey
        baseQArr.forEach(bq=>{
          bq.spreadId= sId;
          bq.apiKey= sApi;
          bq.sheetName= sName;      
          bq.internalCode= iCode;
        });
        allQ= allQ.concat(baseQArr);
      }
      if(allQ.length===0){
        alert("可用题数为0，无法进行大乱斗");
        return;
      }
      if(allQ.length<num){
        alert(`可用题数 ${allQ.length}，将使用全部题`);
        num= allQ.length;
      }
      allQ= shuffle(allQ).slice(0,num);
      currentSheetName="大乱斗套题";
      isBattleMode=true; isMistakeMode=false; isFavoritesMode=false;
      questions= randomOrder ? shuffle(allQ) : allQ;
      startQuiz();
    }

    /********************************************
     * 7) 错题复习
     ********************************************/
    function startMistakeQuiz(){
      logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'startMistakeQuiz'}});
      let mObj= loadMistakesFromCache();
      let keys= Object.keys(mObj);
      if(keys.length===0){
        alert("没有错题记录");
        return;
      }
      isMistakeMode=true; isBattleMode=false; isFavoritesMode=false;
      currentSheetName="错题集";

      let groupMap={};
      keys.forEach(k=>{
        let it= mObj[k];
        let gk= it.spreadId+"||"+ it.sheetName;
        if(!groupMap[gk]) groupMap[gk]=[];
        groupMap[gk].push(it);
      });

      let allQs=[];
      (async()=>{
        for(const gk in groupMap){
          const [spId, sName] = gk.split("||");
          if(!spId || !sName){
            logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'mistake missing spId or sName', gk}});
            return;
          }
          let baseArr=[];
          try{
            let theKey= groupMap[gk][0].apiKey ||"";
            let url= `https://sheets.googleapis.com/v4/spreadsheets/${spId}/values/${encodeURIComponent(sName)}?key=${theKey}`;
            logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'fetch mistake CN', url}});
            let r= await fetch(url);
            if(r.ok){
              let dd= await r.json();
              if(dd.values && dd.values.length>0){
                baseArr= processSheetData(dd.values);
              }
            }
          }catch(e){
            logs.push({type:'error', time:new Date().toLocaleString(), location:userLocation, detail:{message:'fetch mistake CN error', error:e}});
          }
          // 日语
          if(showJapanese){
            let iCode= groupMap[gk][0].internalCode||"";
            let jpEntry= categoriesData.find(x=> x.lang==="JP" && x.internalCode=== iCode && x.spreadId=== spId);
            if(jpEntry){
              try{
                let jurl= `https://sheets.googleapis.com/v4/spreadsheets/${jpEntry.spreadId}/values/${encodeURIComponent(jpEntry.sheetName)}?key=${jpEntry.apiKey}`;
                logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'fetch mistake JP', jurl}});
                let jr= await fetch(jurl);
                if(jr.ok){
                  let jd= await jr.json();
                  if(jd.values && jd.values.length>0){
                    let jpArr= processSheetData(jd.values,true);
                    baseArr.forEach((bb,idx)=>{
                      if(jpArr[idx]){
                        bb.jpQuestion= jpArr[idx].question;
                        bb.jpExplanation= jpArr[idx].explanation;
                      }
                    });
                  }
                }
              }catch(e2){
                logs.push({type:'error', time:new Date().toLocaleString(), location:userLocation, detail:{message:'fetch mistake JP error', error:e2}});
              }
            }
          }

          groupMap[gk].forEach(mItem=>{
            let rowIdx= mItem.rowIndex;
            let found= baseArr[rowIdx];
            if(found){
              allQs.push({
                ...found,
                userAnswer: mItem.userAnswer||"",
                spreadId: spId,
                apiKey: mItem.apiKey,
                sheetName: mItem.sheetName,
                internalCode: mItem.internalCode||"",
                jpQuestion: found.jpQuestion||"",
                jpExplanation: found.jpExplanation||""
              });
            }else{
              allQs.push({...mItem});
            }
          });
        }
        if(allQs.length===0){
          alert("错题数据为空");
          return;
        }
        questions= randomOrder? shuffle(allQs): allQs;
        currentQuestionIndex=0;
        userAnswers=[];
        answerVisible=false;
        mistakeQuestions=[];
        elapsedTime=0;
        clearCurrentExam();

        document.getElementById('container').style.display='none';
        document.getElementById('quiz-container').style.display='block';
        document.getElementById('sheet-name').textContent="错题单元测试";
        loadQuestion();
        startTimer();
      })();
    }

    /********************************************
     * 8) 交卷
     ********************************************/
    function submitQuiz(){
      logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'submitQuiz'}});
      if(!allQuestionsAnswered()){
        if(!confirm("还有未作答题目，确定交卷吗？")) return;
      }
      stopTimer();
      quizEndTime= new Date();
      let ms= quizEndTime - quizStartTime + elapsedTime;
      let mm= Math.floor(ms/60000);
      let ss= Math.floor((ms%60000)/1000);
      let timeFormatted= `${mm}分钟${ss}秒`;

      let incorrect=0, correct=0, unanswered=0;
      let mistakesObj= loadMistakesFromCache();
      mistakeQuestions=[];
      let total= questions.length;
      let totalScore=0, scorePer= 100/ total;

      questions.forEach((q,i)=>{
        let ans= userAnswers[i];
        if(!ans){
          unanswered++;
        } else if(ans===q.answer){
          correct++;
          totalScore+= scorePer;
        } else {
          incorrect++;
          let k= getMistakeKey(q);
          if(mistakesObj[k]){
            mistakesObj[k].count++;
            mistakesObj[k].userAnswer= ans;
          } else{
            mistakesObj[k]= {
              rowIndex: q.rowIndex,
              question: q.question,
              image: q.image,
              answer: q.answer,
              explanation: q.explanation,
              jpQuestion: q.jpQuestion||"",
              jpExplanation: q.jpExplanation||"",
              spreadId: q.spreadId,
              apiKey: q.apiKey,
              sheetName: q.sheetName,
              internalCode: q.internalCode||"",
              count:1,
              userAnswer: ans
            };
          }
          mistakeQuestions.push({...q, userAnswer: ans});
        }
      });
      totalScore= Math.floor(totalScore);
      if(totalScore>100) totalScore=100;
      saveMistakesToCache(mistakesObj);
      clearCurrentExam();

      document.getElementById('quiz-container').style.display='none';
      document.getElementById('result-container').style.display='block';

      let scoreMsg="", scoreClass="";
      if(totalScore===100){
        scoreMsg="满分！非常棒！";
        scoreClass="score-excellent";
      } else if(totalScore>=90){
        scoreMsg="合格！继续加油！";
        scoreClass="score-good";
      } else{
        scoreMsg="不合格，请继续努力！";
        scoreClass="score-bad";
      }

      document.getElementById('score').textContent= `得分：${totalScore}分 - ${scoreMsg}`;
      document.getElementById('score').className= scoreClass;
      document.getElementById('mistake-count').textContent= `做错：${incorrect}道`;
      document.getElementById('correct-count').textContent= `做对：${correct}道`;
      document.getElementById('unanswered-count').textContent= `未做：${unanswered}道`;
      document.getElementById('completion-status').textContent= `完成度：${correct+incorrect}/${total}`;

      let ansed= correct+incorrect;
      let pct= Math.floor(ansed/total*100);
      let bar= document.getElementById('progress-bar');
      bar.style.width= pct+'%';
      bar.textContent= pct+'%';
      if(pct>=90) bar.style.backgroundColor='#28a745';
      else if(pct>=70) bar.style.backgroundColor='#ffc107';
      else bar.style.backgroundColor='#dc3545';

      let history= loadQuizHistory();
      history.push({
        dateTime: new Date().toLocaleString(),
        sheetName: currentSheetName,
        wrongCount: incorrect,
        correctCount: correct,
        unansweredCount: unanswered,
        timeSpent: timeFormatted,
        answered: ansed,
        total,
        score: totalScore
      });
      saveQuizHistory(history);

      logs.push({
        type:'quiz',
        time:new Date().toLocaleString(),
        location:userLocation,
        detail:{
          sheetName: currentSheetName,
          wrongCount: incorrect,
          correctCount: correct,
          unansweredCount: unanswered,
          timeSpent: timeFormatted,
          answered: ansed,
          total,
          score: totalScore
        }
      });
    }

    function allQuestionsAnswered(){
      return questions.every((q,i)=>{
        return userAnswers[i]==="⭕"|| userAnswers[i]==="❌";
      });
    }
    function getMistakeKey(q){
      // [spreadId, rowIndex, sheetName]
      return [q.spreadId, q.rowIndex, q.sheetName].join("||");
    }
    function viewMistakes(){
      logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'viewMistakes'}});
      document.getElementById('result-container').style.display='none';
      document.getElementById('current-mistakes-container').style.display='block';
      const c= document.getElementById('current-mistakes-list');
      c.innerHTML="";
      if(mistakeQuestions.length===0){
        c.innerHTML="<p>本次没有错题</p>";
        return;
      }
      mistakeQuestions.forEach((item,idx)=>{
        let wrap= document.createElement('div');
        let qText= item.question;
        if(showJapanese && item.jpQuestion){
          qText+= "\n-----\n"+ item.jpQuestion;
        }
        let html= `<div><strong>题目 ${idx+1}：</strong>${qText}</div>`;
        if(item.image){
          html+=`<div><img src="${item.image}" style="max-width:100%;max-height:150px;object-fit:contain;margin-top:10px;"></div>`;
        }
        html+=`<div><strong>您的错误答案：</strong>${item.userAnswer}</div>
               <div><strong>正确答案：</strong>${item.answer}</div>`;
        if(item.explanation){
          html+=`<div><strong>解说：</strong>${item.explanation}</div>`;
        }
        if(showJapanese && item.jpExplanation){
          html+= `<div><strong>日文解说：</strong>${item.jpExplanation}</div>`;
        }
        wrap.innerHTML= html;
        c.appendChild(wrap);
      });
    }
    function showScore(){
      logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'showScore'}});
      document.getElementById('current-mistakes-container').style.display='none';
      document.getElementById('result-container').style.display='block';
    }

    /********************************************
     * 9) 继续考试
     ********************************************/
    function continueExam(){
      logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'continueExam'}});
      const exam= loadCurrentExam();
      if(!exam){
        alert("没有未完成考试");
        return;
      }
      exam.randomOrder= loadRandomOrderSetting();
      exam.autoNext= loadAutoNextSetting();
      exam.showJapanese= loadShowJapaneseSetting();

      const {sheetName, currentQuestionIndex: idx, userAnswers:ua, questions:qs, isBattleMode:bm, isMistakeMode:mm, isFavoritesMode:fm}= exam;
      const total= qs.length;
      if(!confirm(`检测到您上次考试未完成(套题：${sheetName},进度：${idx+1}/${total}),是否继续?`)){
        clearCurrentExam();
        return;
      }
      currentSheetName= sheetName;
      currentQuestionIndex= idx;
      userAnswers= ua;
      questions= qs;
      isBattleMode= bm;
      isMistakeMode= mm;
      isFavoritesMode= fm;
      randomOrder= exam.randomOrder;
      autoNext= exam.autoNext;
      showJapanese= exam.showJapanese;
      elapsedTime= exam.elapsedTime||0;

      document.getElementById('random-checkbox').checked= randomOrder;
      document.getElementById('autonext-checkbox').checked= autoNext;
      document.getElementById('show-japanese-checkbox').checked= showJapanese;

      document.getElementById('container').style.display='none';
      document.getElementById('quiz-container').style.display='block';
      document.getElementById('sheet-name').textContent=`当前套题：${currentSheetName}`;
      loadQuestion();
      startTimer();
    }

    /********************************************
     * 10) 计时器
     ********************************************/
    function startTimer(){
      let t= document.getElementById('timer');
      quizStartTime= new Date();
      timerInterval= setInterval(()=>{
        let now= new Date();
        let e= now - quizStartTime + elapsedTime;
        let m= Math.floor(e/60000);
        let s= Math.floor((e%60000)/1000);
        t.textContent=`时间：${String(m).padStart(2,'0')}分钟${String(s).padStart(2,'0')}秒`;
      },1000);
    }
    function stopTimer(){
      clearInterval(timerInterval);
    }
    function pauseExam(){
      logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'pauseExam'}});
      stopTimer();
      elapsedTime += (new Date()) - quizStartTime;
      saveCurrentExam();
      alert("考试进度已保存！");
      document.getElementById('quiz-container').style.display='none';
      document.getElementById('container').style.display='block';
      if(loadCurrentExam()){
        document.getElementById('continue-exam-btn').style.display='inline-block';
      }
    }
    function resetQuiz(){
      logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'resetQuiz'}});
      stopTimer();
      hideAll();
      document.getElementById('container').style.display='block';
      isBattleMode=false; isMistakeMode=false; isFavoritesMode=false;
      // 重新渲染类别
      renderCategoryButtons();
      if(loadCurrentExam()){
        document.getElementById('continue-exam-btn').style.display='inline-block';
      } else{
        document.getElementById('continue-exam-btn').style.display='none';
      }
    }

    /********************************************
     * 11) 清空历史
     ********************************************/
    function clearAllHistory(){
      logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'clearAllHistory'}});
      if(!confirm("确认清除所有历史记录和错题吗？")) return;
      localStorage.clear();
      // 清除内存中的 favorites
      favorites = {};
      alert("历史已清除，包括我的收藏");
      resetQuiz();
    }

    /********************************************
     * 12) 日志查看 & 写入
     ********************************************/
    async function viewConsoleLogs(){
      let pwd= prompt("请输入查看日志密码：");
      if(pwd!=="Aa123456"){
        alert("密码错误");
        return;
      }
      try{
        await recordLogsToSheet();
      }catch(e){
        console.error("写日志失败", e);
      }
      showConsoleLogsFromSheet();
    }

    async function recordLogsToSheet(){
      if(logs.length===0) return;
      // 简化：存4列 [type, time, location, detail]
      const values= logs.map(l=>{
        let detailStr= typeof l.detail==='object' ? JSON.stringify(l.detail): (l.detail||"");
        return [l.type, l.time||"", l.location||"", detailStr];
      });
      let url= `https://sheets.googleapis.com/v4/spreadsheets/${SYSTEM_SPREADSHEET_ID}/values/${encodeURIComponent(LOG_SHEET_NAME)}!A1:append?valueInputOption=RAW&key=${SYSTEM_API_KEY}`;
      let body= { values };
      let r= await fetch(url,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(body)
      });
      if(!r.ok){
        throw new Error("recordLogsToSheet: append failed");
      }
      logs=[];
    }

    async function showConsoleLogsFromSheet(){
      hideAll();
      document.getElementById('console-logs-container').style.display='block';
      const c= document.getElementById('console-logs-content');
      c.textContent="加载中...";
      try{
        let url= `https://sheets.googleapis.com/v4/spreadsheets/${SYSTEM_SPREADSHEET_ID}/values/${encodeURIComponent(LOG_SHEET_NAME)}!A:Z?key=${SYSTEM_API_KEY}`;
        let r= await fetch(url);
        if(!r.ok){
          c.innerHTML="<p>日志加载失败</p>";
          return;
        }
        let d= await r.json();
        if(!d.values || d.values.length<=1){
          c.innerHTML="<p>暂无日志</p>";
          return;
        }
        let table= document.createElement('table');
        let thead= document.createElement('thead');
        let thr= document.createElement('tr');
        ["类型","时间","地点","明细"].forEach(h=>{
          let th= document.createElement('th');
          th.textContent=h;
          thr.appendChild(th);
        });
        thead.appendChild(thr);
        table.appendChild(thead);

        let tbody= document.createElement('tbody');
        d.values.slice(1).forEach(rowArr=>{
          let tr= document.createElement('tr');
          for(let i=0;i<4;i++){
            let td= document.createElement('td');
            td.textContent= rowArr[i]||"";
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        c.innerHTML="";
        c.appendChild(table);
      }catch(e){
        console.error(e);
        c.innerHTML="<p>日志异常</p>";
      }
    }

    /********************************************
     * 13) 功能介绍 / 更新日志 / 汇总表现
     ********************************************/
    function showFunctionIntro(){
      logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'showFunctionIntro'}});
      hideAll();
      document.getElementById('function-intro-container').style.display='block';
    }
    function showUpdateLogs(){
      logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'showUpdateLogs'}});
      hideAll();
      document.getElementById('update-logs-container').style.display='block';
    }
    function showSummary(){
      logs.push({type:'log', time:new Date().toLocaleString(), location:userLocation, detail:{message:'showSummary'}});
      hideAll();
      document.getElementById('summary-container').style.display='block';
      let s= document.getElementById('summary-content');
      s.textContent="加载中...";

      let his= loadQuizHistory();
      if(his.length===0){
        s.innerHTML="<p>暂无做题历史</p>";
        return;
      }
      let mapSum={};
      his.forEach(e=>{
        if(!mapSum[e.sheetName]){
          mapSum[e.sheetName]={
            attempts:0,
            totalWrong:0,
            totalCorrect:0,
            totalUnanswered:0,
            totalTime:0,
            lastCompletionTime:"",
            lastCompletion:{answered:0, total:0},
            scores:[],
            individual:[]
          };
        }
        let st= mapSum[e.sheetName];
        st.attempts++;
        st.totalWrong+= e.wrongCount;
        st.totalCorrect+= e.correctCount;
        st.totalUnanswered+= e.unansweredCount;
        let match= e.timeSpent.match(/(\d+)分钟(\d+)秒/);
        let secs=0;
        if(match){
          secs= parseInt(match[1])*60 + parseInt(match[2]);
        }
        st.totalTime+= secs;
        st.lastCompletionTime= e.dateTime;
        st.lastCompletion= { answered:e.answered, total:e.total };
        st.scores.push(e.score);
        st.individual.push(e);
      });

      let html="";
      for(const sn in mapSum){
        let st= mapSum[sn];
        let avgWrong= (st.totalWrong/st.attempts).toFixed(2);
        let avgCorrect= (st.totalCorrect/st.attempts).toFixed(2);
        let avgUnans= (st.totalUnanswered/st.attempts).toFixed(2);
        let avgScore= (st.scores.reduce((a,b)=>a+b,0)/ st.attempts).toFixed(2);
        let avgSec= Math.floor(st.totalTime/st.attempts);
        let mm= Math.floor(avgSec/60);
        let ss= avgSec%60;
        let avgTime= `${mm}分钟${ss}秒`;

        html+=`<div class="summary-sheet">
          <h3>套题：${sn}</h3>
          <table>
            <tr>
              <th>总练习次数</th>
              <th>平均做错数</th>
              <th>平均做对数</th>
              <th>平均未做数</th>
              <th>平均得分</th>
              <th>平均花费时间</th>
              <th>最近一次完成时间</th>
              <th>最近一次完成度</th>
            </tr>
            <tr>
              <td>${st.attempts}</td>
              <td>${avgWrong}</td>
              <td>${avgCorrect}</td>
              <td>${avgUnans}</td>
              <td>${avgScore}</td>
              <td>${avgTime}</td>
              <td>${st.lastCompletionTime}</td>
              <td>${st.lastCompletion.answered}/${st.lastCompletion.total}</td>
            </tr>
          </table>
          <h4 style="margin-top:10px;">每次做题表现：</h4>
          <table>
            <tr>
              <th>日期时间</th>
              <th>做错数</th>
              <th>做对数</th>
              <th>未做数</th>
              <th>花费时间</th>
              <th>得分</th>
              <th>完成度</th>
            </tr>`;
        st.individual.forEach(e=>{
          html+=`<tr>
            <td>${e.dateTime}</td>
            <td>${e.wrongCount}</td>
            <td>${e.correctCount}</td>
            <td>${e.unansweredCount}</td>
            <td>${e.timeSpent}</td>
            <td>${e.score}</td>
            <td>${e.answered}/${e.total}</td>
          </tr>`;
        });
        html+=`</table></div>`;
      }
      s.innerHTML=html;
    }

    /********************************************
     * 14) 隐藏容器
     ********************************************/
    function hideAll(){
      document.getElementById('container').style.display='none';
      document.getElementById('quiz-container').style.display='none';
      document.getElementById('result-container').style.display='none';
      document.getElementById('mistake-review-container').style.display='none';
      document.getElementById('current-mistakes-container').style.display='none';
      document.getElementById('console-logs-container').style.display='none';
      document.getElementById('update-logs-container').style.display='none';
      document.getElementById('function-intro-container').style.display='none';
      document.getElementById('summary-container').style.display='none';
      document.getElementById('favorites-container').style.display='none';
    }

    /********************************************
     * 15) 初始消息、更新日志、功能介绍
     ********************************************/
    async function loadInitialMessages(){
      const box= document.getElementById('initial-message');
      box.innerHTML="<p>加载中...</p>";
      try{
        let url= `https://sheets.googleapis.com/v4/spreadsheets/${SYSTEM_SPREADSHEET_ID}/values/CN!B1:B5?key=${SYSTEM_API_KEY}`;
        let r= await fetch(url);
        if(!r.ok){
          box.innerHTML="<p>无法加载留言</p>";
          return;
        }
        let d= await r.json();
        if(!d.values || d.values.length===0){
          box.innerHTML="<p>暂无留言</p>";
          return;
        }
        box.innerHTML="";
        d.values.slice(0,4).forEach(row=>{
          let msg= row[0]? row[0].trim():"";
          if(msg){
            let p= document.createElement('p');
            p.textContent= msg;
            box.appendChild(p);
          }
        });
        if(d.values.length>=5){
          let qr= d.values[4][0]? d.values[4][0].trim():"";
          if(qr){
            let img= document.createElement('img');
            img.src= qr;
            img.alt="加入社区二维码";
            img.onclick= triggerScan;
            box.appendChild(img);
          }
        }
      }catch(e){
        console.error(e);
        box.innerHTML="<p>留言加载出错</p>";
      }
    }
    function triggerScan(){
      let img= document.querySelector('#initial-message img');
      if(img) window.open(img.src,'_blank');
    }

    async function loadUpdateLogs(){
      const box= document.getElementById('update-logs-list');
      box.innerHTML="<p>加载中...</p>";
      try{
        let url= `https://sheets.googleapis.com/v4/spreadsheets/${SYSTEM_SPREADSHEET_ID}/values/CN!C1:D?key=${SYSTEM_API_KEY}`;
        let r= await fetch(url);
        if(!r.ok){
          box.innerHTML="<p>无法加载更新日志</p>";
          return;
        }
        let d= await r.json();
        if(!d.values || d.values.length<2){
          box.innerHTML="<p>暂无更新日志</p>";
          return;
        }
        box.innerHTML="";
        let table= document.createElement('table');
        let thead= document.createElement('thead');
        let tr= document.createElement('tr');
        ["日期","更新内容"].forEach(h=>{
          let th= document.createElement('th');
          th.textContent=h;
          tr.appendChild(th);
        });
        thead.appendChild(tr);
        table.appendChild(thead);

        let tbody= document.createElement('tbody');
        d.values.slice(1).forEach(rowArr=>{
          let cDate= rowArr[0]? rowArr[0].trim():"";
          let cInfo= rowArr[1]? rowArr[1].trim():"";
          if(cDate||cInfo){
            let tr2= document.createElement('tr');
            let td1= document.createElement('td');
            td1.textContent= cDate;
            let td2= document.createElement('td');
            td2.textContent= cInfo;
            tr2.appendChild(td1);
            tr2.appendChild(td2);
            tbody.appendChild(tr2);
          }
        });
        table.appendChild(tbody);
        if(!tbody.children.length){
          box.innerHTML="<p>暂无更新日志</p>";
          return;
        }
        box.appendChild(table);
      }catch(e){
        console.error(e);
        box.innerHTML="<p>加载更新日志失败</p>";
      }
    }
    async function loadFunctionIntro(){
      const box= document.getElementById('function-intro-content');
      box.innerHTML="<p>加载中...</p>";
      try{
        let url= `https://sheets.googleapis.com/v4/spreadsheets/${SYSTEM_SPREADSHEET_ID}/values/CN!E1:G?key=${SYSTEM_API_KEY}`;
        let r= await fetch(url);
        if(!r.ok){
          box.innerHTML="<p>无法加载功能介绍</p>";
          return;
        }
        let d= await r.json();
        if(!d.values || d.values.length<2){
          box.innerHTML="<p>暂无功能介绍</p>";
          return;
        }
        box.innerHTML="";
        let table= document.createElement('table');
        let thead= document.createElement('thead');
        let tr2= document.createElement('tr');
        ["功能名称","功能描述","备注"].forEach(h=>{
          let th= document.createElement('th');
          th.textContent=h;
          tr2.appendChild(th);
        });
        thead.appendChild(tr2);
        table.appendChild(thead);

        let tbody= document.createElement('tbody');
        d.values.slice(1).forEach(rowArr=>{
          let fName= rowArr[0]? rowArr[0].trim():"";
          let fDesc= rowArr[1]? rowArr[1].trim():"";
          let fRem= rowArr[2]? rowArr[2].trim():"";
          if(fName||fDesc||fRem){
            let tr3= document.createElement('tr');
            let td1= document.createElement('td'); td1.textContent=fName;
            let td2= document.createElement('td'); td2.textContent=fDesc;
            let td3= document.createElement('td'); td3.textContent=fRem;
            tr3.appendChild(td1);
            tr3.appendChild(td2);
            tr3.appendChild(td3);
            tbody.appendChild(tr3);
          }
        });
        table.appendChild(tbody);
        if(!tbody.children.length){
          box.innerHTML="<p>暂无功能介绍</p>";
          return;
        }
        box.appendChild(table);
      }catch(e){
        console.error(e);
        box.innerHTML="<p>加载功能介绍出错</p>";
      }
    }

    /********************************************
     * 16) 本地存储
     ********************************************/
    function loadRandomOrderSetting(){
      return localStorage.getItem('randomOrder')==='true';
    }
    function saveRandomOrderSetting(v){
      localStorage.setItem('randomOrder', v?'true':'false');
    }
    function loadAutoNextSetting(){
      return localStorage.getItem('autoNext')==='true';
    }
    function saveAutoNextSetting(v){
      localStorage.setItem('autoNext', v?'true':'false');
    }
    function loadShowJapaneseSetting(){
      return localStorage.getItem('showJapanese')==='true';
    }
    function saveShowJapaneseSetting(v){
      localStorage.setItem('showJapanese', v?'true':'false');
    }

    function loadCurrentExam(){
      let ex= localStorage.getItem('currentExam');
      return ex ? JSON.parse(ex): null;
    }
    function saveCurrentExam(){
      let cur= {
        sheetName: currentSheetName,
        currentQuestionIndex,
        userAnswers,
        questions,
        randomOrder,
        autoNext,
        elapsedTime,
        isBattleMode,
        isMistakeMode,
        isFavoritesMode,
        showJapanese
      };
      localStorage.setItem('currentExam', JSON.stringify(cur));
    }
    function clearCurrentExam(){
      localStorage.removeItem('currentExam');
      document.getElementById('continue-exam-btn').style.display='none';
    }

    function loadFavorites(){
      let f= localStorage.getItem('favorites');
      return f? JSON.parse(f): {};
    }
    function saveFavorites(obj){
      localStorage.setItem('favorites', JSON.stringify(obj));
    }

    function loadMistakesFromCache(){
      let m= localStorage.getItem('mistakes');
      return m? JSON.parse(m): {};
    }
    function saveMistakesToCache(obj){
      localStorage.setItem('mistakes', JSON.stringify(obj));
    }

    function loadQuizHistory(){
      let h= localStorage.getItem('quizHistory');
      return h? JSON.parse(h): [];
    }
    function saveQuizHistory(h){
      localStorage.setItem('quizHistory', JSON.stringify(h));
    }

    /********************************************
     * 17) IP & 位置 => log
     ********************************************/
    async function getClientIPAndLogAccess(){
      let visitTime= new Date().toLocaleString();
      let deviceInfo= navigator.userAgent;
      let ip="未知IP";
      try{
        let r= await fetch("https://api.ipify.org?format=json");
        let d= await r.json();
        ip= d.ip||"未知IP";
      }catch(e){
        console.warn("获取IP失败", e);
      }
      try{
        let r2= await fetch(`https://ipapi.co/${ip}/json/`);
        let d2= await r2.json();
        if(d2 && d2.city && d2.country_name){
          userLocation= `${d2.city}, ${d2.country_name}`;
        }
      }catch(e2){
        console.warn("获取地理位置失败", e2);
      }
      logs.push({
        type:'access',
        time:visitTime,
        location:userLocation,
        detail:{
          device: deviceInfo,
          ip: ip
        }
      });
    }
  </script>
</body>
</html>