<!DOCTYPE html>
<html lang="ko">
<head><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5561937816024308"
     crossorigin="anonymous"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>zalem.app - KR</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #e9f5ff;
      box-sizing: border-box;
    }

    h1 {
      text-align: center;
      color: #fff;
      background-color: #007BFF;
      padding: 15px 0;
      margin: 0;
      cursor: pointer; /* 마우스 호버 시 손 모양으로 표시 */
    }

    /* 도메인, 슬로건, 타이틀 스타일 */
    h1 .domain {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    h1 .slogan {
      font-size: 18px;
      margin-bottom: 5px;
    }
    h1 .title {
      font-size: 15px;
    }

    h2 {
      text-align: center;
      color: #333;
      margin: 15px 0;
      font-size: 20px;
    }

    #container, 
    #quiz-container, 
    #result-container, 
    #mistake-review-container, 
    #current-mistakes-container, 
    #console-logs-container, 
    #update-logs-container, 
    #function-intro-container, 
    #summary-container, 
    #battle-mode-selection-container {
      margin: 30px auto;
      max-width: 800px;
      border: 2px solid #ddd;
      border-radius: 10px;
      background-color: #fff;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 20px;
      display: none; /* 기본적으로 숨김 */
    }

    #container, #battle-mode-selection-container {
      display: block; /* 메인 컨테이너와 배틀 모드 선택창은 기본 표시 */
    }

    #sheet-selection {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    #sheet-selection button {
      flex: 0 1 auto;
      padding: 10px 15px;
      background: #007BFF;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    #sheet-selection button:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }

    #info {
      text-align: center;
      margin-top: 20px;
      color: #555;
      font-size: 14px;
      line-height: 1.6;
    }

    #info .top-buttons, 
    #info .battle-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }

    #info .bottom-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    #info button {
      padding: 10px 15px;
      background: #4DAFFF;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    #info button:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }

    #random-option {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    #random-option label {
      display: flex;
      align-items: center;
      cursor: pointer;
      padding:10px 20px;
      border:2px solid #007BFF;
      border-radius:5px;
      background:#fff;
    }
    #random-option input[type="checkbox"] {
      width:24px;
      height:24px;
      margin-right:10px;
      vertical-align:middle;
    }

    #question {
      font-size: 18px;
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
      background-color: #fdf8e4;
      text-align: center;
      min-height: 50px; 
      line-height: 1.4;
      white-space: pre-wrap; /* 줄바꿈 유지 */
    }

    #image {
      margin-bottom: 20px;
      border: 2px solid #ccc;
      border-radius: 10px;
      background-color: #f0f8ff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 50px; 
      padding: 10px;
    }
    #image img {
      max-width: 100%;
      max-height: 150px;
      object-fit: contain;
    }

    .options, .controls {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
    }
    .options button, .controls button {
      flex: 1;
      margin: 0 5px;
    }

    button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease-in-out;
      text-align: center;
      white-space: nowrap;
    }
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }

    .correct {
      background: #28a745; /* 초록색 */
      color: #fff;
    }
    .correct.highlight {
      background: #1e7e34;
      box-shadow: 0 0 10px #1e7e34;
    }
    .wrong {
      background: #dc3545; /* 빨간색 */
      color: #fff;
    }
    .wrong.highlight {
      background: #c82333;
      box-shadow: 0 0 10px #c82333;
    }

    #answer-display {
      font-size: 18px;
      font-weight: bold;
      color: #FF4D4D;
      margin-top: 10px;
      text-align: center;
      white-space: pre-wrap; /* 줄바꿈 유지 */
    }

    #remaining-questions {
      text-align: center; 
      margin-top: 20px;
      font-size: 16px;
      color: #333;
    }

    #mistake-questions > div, 
    #current-mistakes-list > div {
      border-bottom: 1px solid #ccc;
      margin-bottom: 15px;
      padding-bottom: 15px;
      line-height: 1.4;
    }
    #mistake-questions img, 
    #current-mistakes-list img {
      margin-top: 10px;
      border-radius: 5px;
      max-height:150px;
      object-fit:contain;
      max-width:100%;
    }

    #mistake-review-container button, 
    #current-mistakes-container button, 
    #console-logs-container button, 
    #update-logs-container button, 
    #function-intro-container button, 
    #summary-container button, 
    #battle-mode-selection-container button {
      margin-top: 10px;
    }

    #console-logs-content table {
      width:100%;
      border-collapse: collapse;
      margin-top:20px;
    }
    #console-logs-content table, 
    #console-logs-content th, 
    #console-logs-content td {
      border:1px solid #ccc;
      padding:5px;
      text-align:left;
      font-size:14px;
    }
    #console-logs-content th {
      background: #f9f9f9;
    }

    #update-logs-container, 
    #function-intro-container, 
    #summary-container, 
    #battle-mode-selection-container {
      display:none;
    }

    #update-logs-list, 
    #summary-content {
      font-size:14px;
      line-height:1.6;
    }

    /* 진행도 표시바 */
    .progress-bar-container {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 25px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-bar {
      height: 25px;
      width: 0%;
      background-color: #28a745;
      text-align: center;
      line-height: 25px;
      color: white;
      border-radius: 25px;
      transition: width 0.5s ease-in-out;
      font-size: 16px;
      font-weight: bold;
    }

    /* 요약 테이블 */
    .summary-sheet {
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 15px;
      background-color: #f9f9f9;
    }
    .summary-sheet h3 {
      margin-top: 0;
    }
    .summary-sheet table {
      width: 100%;
      border-collapse: collapse;
    }
    .summary-sheet th, 
    .summary-sheet td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    .summary-sheet th {
      background-color: #f1f1f1;
    }

    /* 점수 안내 메시지 */
    .score-excellent {
      color: #28a745; /* 초록 */
      font-size: 24px;
      font-weight: bold;
    }
    .score-good {
      color: #ffc107; /* 노랑 */
      font-size: 24px;
      font-weight: bold;
    }
    .score-bad {
      color: #dc3545; /* 빨강 */
      font-size: 24px;
      font-weight: bold;
    }

    /* 타이머 */
    #timer {
      text-align: center;
      font-size: 18px;
      margin-top: 10px;
      color: #333;
    }

    /* 배틀 모드 선택 */
    #battle-mode-selection-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #battle-mode-selection {
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      max-height: 80%;
      overflow-y: auto;
    }
    #battle-mode-selection h3 {
      margin-top: 0;
    }
    #battle-mode-selection .sheet-option {
      margin-bottom: 10px;
    }
    #battle-mode-selection button {
      margin-top: 10px;
    }

    /* 초기 메시지 */
    #initial-message {
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
      color: #856404;
      font-size: 16px;
      line-height: 1.5;
    }
    #initial-message p {
      margin: 10px 0;
    }
    #initial-message img {
      display: block;
      margin: 20px auto 10px auto;
      max-width: 200px;
      cursor: pointer;
    }
  </style>
  
  <!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ER1N8KVZPZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  // 自动识别路径并记录语言属性
  const languageMap = {
    '/jp': 'Japanese',
    '/cn': 'Chinese',
    '/en': 'English',
    '/vn': 'Vietnamese',
    '/kr': 'Korean'
  };
  const currentPath = window.location.pathname;
  const currentLanguage = languageMap[currentPath] || 'Unknown';

  // 配置页面路径
  gtag('config', 'G-ER1N8KVZPZ', {
    'page_path': currentPath
  });

  // 自定义事件记录语言属性
  gtag('event', 'set_language', {
    'event_category': 'Language',
    'event_label': currentLanguage,
    'value': 1
  });
</script>
</head>
<body>
  <!-- 대제목: 도메인 / 슬로건 / 타이틀 -->
  <h1 onclick="resetQuiz()">
    <div class="domain">zalem.app</div>
<!--     <div class="slogan">네온이 천 리, 아시카가에서 시작합니다. 아시카가 운전학교에 오신 걸 환영합니다!</div> -->
    <div class="title">도로는 수천 가지, 안전이 우선! 부주의하면 소중한 가족이 슬퍼합니다.</div>
  </h1>

  <div id="container">
    <!-- 우선순위1: 문제집(시트) 선택 -->
    <h2>문제집을 선택하세요</h2>
    <div id="random-option">
      <label>
        <input type="checkbox" id="random-checkbox"> 랜덤 순서
      </label>
      <label>
        <input type="checkbox" id="autonext-checkbox"> 자동으로 다음 문제로 이동
      </label>
    </div>

    <div id="sheet-selection">불러오는 중...</div>
    
    <!-- 우선순위1: 버튼 그룹 (배틀 모드 등) -->
    <div id="info">
      <div class="top-buttons">
        <button onclick="showSummary()" style="background: #17a2b8;">테스트 요약</button>
        <button onclick="startMistakeReview()">오답 노트 복습</button>
        <button id="continue-exam-btn" style="display:none;" onclick="continueExam()">이어서 시험 보기</button>
        <button onclick="openBattleModeSelection()" style="background: #6f42c1;">배틀 모드</button>
      </div>
      <div class="bottom-buttons">
        <button onclick="showFunctionIntro()">기능 소개</button>
        <button onclick="showUpdateLogs()">업데이트 로그</button>
        <button onclick="viewConsoleLogs()">콘솔 로그</button>
        <button onclick="clearAllHistory()">기록 삭제</button>
      </div>
    </div>

    <!-- 여백을 조금 둠 -->
    <div style="height: 20px;"></div>

    <!-- 우선순위2: 초기 안내 메시지 영역 -->
    <div id="initial-message">
      <!-- 자바스크립트로 동적으로 삽입 -->
      <p>불러오는 중...</p>
    </div>
  </div>

  <!-- 배틀 모드 선택 컨테이너 -->
  <div id="battle-mode-selection-container">
    <div id="battle-mode-selection">
      <h3>배틀 모드 문제집을 선택하세요</h3>
      <div id="battle-sheet-selection">
        <!-- JS로 체크박스를 동적 생성 -->
      </div>
      <button onclick="startBattleMode()">배틀 모드 시작</button>
      <button onclick="closeBattleModeSelection()">취소</button>
    </div>
  </div>

  <div id="quiz-container" style="display: none;">
    <h2 id="sheet-name">불러오는 중...</h2>
    <div id="question">불러오는 중...</div>
    <div id="image" style="display:none;"></div>
    <div class="options">
      <button id="btn-correct" class="correct" onclick="selectAnswer('⭕')">⭕ 맞다</button>
      <button id="btn-wrong" class="wrong" onclick="selectAnswer('❌')">❌ 틀리다</button>
    </div>
    <div class="controls">
      <button onclick="previousQuestion()">이전 문제</button>
      <button onclick="nextQuestion()">다음 문제</button>
    </div>
    <div id="remaining-questions"></div>
    <div id="timer">시간: 00분00초</div>
    <div id="answer-display"></div>
    <div style="text-align: center; margin-top: 20px;">
      <button onclick="toggleAnswer()">정답 표시/숨기기</button>
      <button onclick="pauseExam()">시험 중단</button>
      <button onclick="submitQuiz()">시험 제출</button>
    </div>
  </div>

  <div id="result-container" style="display: none;">
    <h2>시험 종료</h2>
    <div style="text-align: center;">
      <p id="score" class="score-excellent" style="font-size: 32px; font-weight: bold; color: #28a745;"></p>
      <p id="mistake-count" style="font-size: 20px; color: #dc3545;"></p>
      <p id="correct-count" style="font-size: 20px; color: #28a745;"></p>
      <p id="unanswered-count" style="font-size: 20px; color: #ffc107;"></p>
      <p id="completion-status"></p>
      <div class="progress-bar-container">
        <div class="progress-bar" id="progress-bar">0%</div>
      </div>
    </div>
    <button onclick="resetQuiz()">다시 시도</button>
    <button onclick="viewMistakes()">이번 시험 오답 보기</button>
  </div>

  <div id="current-mistakes-container" style="display:none;">
    <h2>이번 시험의 오답</h2>
    <div id="current-mistakes-list"></div>
    <button onclick="startMistakeReview()">오답 노트 복습</button>
    <button onclick="showScore()">점수 화면으로 돌아가기</button>
    <button onclick="resetQuiz()">처음으로</button>
  </div>

  <div id="mistake-review-container" style="display:none;">
    <h2>오답 노트 복습</h2>
    <div id="mistake-questions"></div>
    <button onclick="resetQuiz()">처음으로</button>
  </div>

  <div id="console-logs-container" style="display:none;">
    <h2>콘솔 로그</h2>
    <div id="console-logs-content">불러오는 중...</div>
    <button onclick="resetQuiz()">처음으로</button>
  </div>

  <div id="update-logs-container" style="display:none;">
    <h2>업데이트 로그</h2>
    <div id="update-logs-list">
      <!-- 자바스크립트로 동적 표시 -->
      <p>불러오는 중...</p>
    </div>
    <button onclick="resetQuiz()">처음으로</button>
  </div>

  <div id="function-intro-container" style="display:none;">
    <h2>기능 소개</h2>
    <div id="function-intro-content">
      <!-- 자바스크립트로 동적 표시 -->
      <p>불러오는 중...</p>
    </div>
    <button onclick="resetQuiz()">처음으로</button>
  </div>

  <div id="summary-container" style="display:none;">
    <h2>테스트 결과 요약</h2>
    <div id="summary-content">불러오는 중...</div>
    <button onclick="resetQuiz()">처음으로</button>
  </div>

  <script>
    /**************************************************
     * 1) 새 한국어 버전 문제집용 API 정보
     **************************************************/
    // 문제집(시험용) 스프레드시트
    const apiKey = "AIzaSyApEcu1zgGEexoS_diT6PkCPQDWkX5Adhk";
    // 한국어 버전 문제집 스프레드시트ID
    const spreadsheetId = "1OX_2uHKB6TpcnNqsUwaLjXydHkCkiENMZLcwtjntNqI";

    /**************************************************
     * 2) 시스템 공용 스프레드시트(KR 시트) 사용
     **************************************************/
    const systemApiKey = "AIzaSyApEcu1zgGEexoS_diT6PkCPQDWkX5Adhk";
    // 시스템표(스프레드시트) ID (동일)
    const systemSpreadsheetId = "1bkTNZje3ehMPn2-PNH-yLT1kPpRvs_HAfiYuPg2jA6w";
    // 이번에는 KR 시트를 사용
    // KR!B : 초기 메시지
    // KR!C, KR!D : 업데이트 로그
    // KR!E, KR!F, KR!G : 기능 소개

    let sheetNames = [];
    let questions = [];
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let currentSheetName = "";
    let answerVisible = false;
    let mistakeQuestions = [];
    let logs = [];
    let quizStartTime = null; // 시험 시작 시간
    let quizEndTime = null;   // 시험 종료 시간
    let timerInterval = null; // 타이머 interval
    let elapsedTime = 0;      // 누적 소요 시간(밀리초)
    let userLocation = "알 수 없는 위치";
    let isBattleMode = false; // 배틀 모드 여부

    let randomOrder = loadRandomOrderSetting();
    let autoNext = loadAutoNextSetting();

    // DOM이 준비된 후에 체크박스 설정 등을 진행
    document.addEventListener('DOMContentLoaded', () => {
      const randomCheckbox = document.getElementById('random-checkbox');
      randomCheckbox.checked = randomOrder; 
      randomCheckbox.addEventListener('change', () => {
        randomOrder = randomCheckbox.checked;
        saveRandomOrderSetting(randomOrder);
      });

      const autoNextCheckbox = document.getElementById('autonext-checkbox');
      autoNextCheckbox.checked = autoNext;
      autoNextCheckbox.addEventListener('change', () => {
        autoNext = autoNextCheckbox.checked;
        saveAutoNextSetting(autoNext);
      });

      const continueExamBtn = document.getElementById('continue-exam-btn');
      const savedExam = loadCurrentExam();
      if(savedExam) {
        continueExamBtn.style.display = 'inline-block';
      }

      // 시스템 스프레드시트에서 필요한 정보 로드
      loadInitialMessages();   // 초기 메시지 (KR!B열)
      loadUpdateLogs();        // 업데이트 로그 (KR!C,KR!D)
      loadFunctionIntro();     // 기능 소개 (KR!E,KR!F,KR!G)
    });

    // 사용자 접속 로깅 (IP, 위치)
    getClientIPAndLogAccess();
    // 문제집 목록 로드
    fetchSheetNames();

    // 떠나기 전에 현재 시험 상태 저장
    window.addEventListener('beforeunload', () => {
      if(document.getElementById('quiz-container').style.display === 'block') {
        saveCurrentExam();
      }
    });

    function loadRandomOrderSetting() {
      const setting = localStorage.getItem('randomOrder');
      return setting === 'true'; 
    }

    function saveRandomOrderSetting(value) {
      localStorage.setItem('randomOrder', value ? 'true' : 'false');
    }

    function loadAutoNextSetting() {
      const setting = localStorage.getItem('autoNext');
      return setting === 'true'; 
    }

    function saveAutoNextSetting(value) {
      localStorage.setItem('autoNext', value ? 'true' : 'false');
    }

    function loadCurrentExam() {
      const exam = localStorage.getItem('currentExam');
      return exam ? JSON.parse(exam) : null;
    }

    function saveCurrentExam() {
      const currentExam = {
        sheetName: currentSheetName,
        currentQuestionIndex,
        userAnswers,
        questions,
        randomOrder,
        autoNext,
        elapsedTime,
        isBattleMode
      };
      localStorage.setItem('currentExam', JSON.stringify(currentExam));
    }

    function clearCurrentExam() {
      localStorage.removeItem('currentExam');
      const continueExamBtn = document.getElementById('continue-exam-btn');
      if (continueExamBtn) {
        continueExamBtn.style.display = 'none';
      }
    }

    async function getClientIPAndLogAccess() {
      const visitTime = new Date().toLocaleString();
      const deviceInfo = navigator.userAgent;
      let ip = "알 수 없는 IP";
      try {
        const res = await fetch('https://api.ipify.org?format=json');
        const data = await res.json();
        ip = data.ip || "알 수 없는 IP";
      } catch(e) {
        console.warn("IP 획득 실패:", e);
      }
      
      // 지리 정보 로드
      try {
        const geoRes = await fetch(`https://ipapi.co/${ip}/json/`);
        const geoData = await geoRes.json();
        if(geoData && geoData.city && geoData.country_name) {
          userLocation = `${geoData.city}, ${geoData.country_name}`;
        } else {
          userLocation = "알 수 없는 위치";
        }
      } catch(e) {
        console.warn("위치 정보 획득 실패:", e);
        userLocation = "알 수 없는 위치";
      }

      logs.push({
        type: 'access',
        time: visitTime,
        location: userLocation,
        detail: {
          device: deviceInfo,
          ip: ip
        }
      });
    }

    function loadMistakesFromCache() {
      const mistakes = localStorage.getItem('mistakes');
      return mistakes ? JSON.parse(mistakes) : {};
    }

    function saveMistakesToCache(mistakesObj) {
      localStorage.setItem('mistakes', JSON.stringify(mistakesObj));
    }

    function loadQuizHistory() {
      const history = localStorage.getItem('quizHistory');
      return history ? JSON.parse(history) : [];
    }

    function saveQuizHistory(history) {
      localStorage.setItem('quizHistory', JSON.stringify(history));
    }

    /*********************************************
     * 시트 이름 전체 로드
     *********************************************/
    async function fetchSheetNames() {
      const selectionContainer = document.getElementById('sheet-selection');
      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?key=${apiKey}`;
        const response = await fetch(url);
        if(!response.ok) {
          selectionContainer.innerHTML = "<p>문제집 목록을 불러오지 못했습니다. 네트워크나 설정을 확인하세요.</p>";
          return;
        }
        const data = await response.json();
        if(!data.sheets) {
          selectionContainer.innerHTML = "<p>문제집을 찾을 수 없습니다. Google Sheet 설정을 확인하세요.</p>";
          return;
        }
        // 전체 시트를 모두 불러옴
        sheetNames = data.sheets.map(sheet => sheet.properties.title);

        if(sheetNames.length === 0) {
          selectionContainer.innerHTML = "<p>문제집이 없습니다.</p>";
          return;
        }
        displaySheetSelection();
        populateBattleModeSelection();
      } catch (e) {
        console.error(e);
        selectionContainer.innerHTML = "<p>문제집 목록을 불러오는 데 실패했습니다. 콘솔을 확인하세요.</p>";
      }
    }

    function assignSheetButtonColors() {
      const history = loadQuizHistory();
      sheetNames.forEach(sheet => {
        const sheetHistory = history.filter(entry => entry.sheetName === sheet);
        const totalAttempts = sheetHistory.length;
        const totalWrong = sheetHistory.reduce((sum, entry) => sum + entry.wrongCount, 0);
        const averageWrong = totalAttempts > 0 ? (totalWrong / totalAttempts) : 0;

        // 평균 오답 개수에 따라 색상 결정
        let color = '#28a745'; // 오답 적음 → 초록
        if (averageWrong >= 5) {
          color = '#dc3545'; // 오답 많음 → 빨강
        } else if (averageWrong >= 1) {
          color = '#ffc107'; // 중간 → 노랑
        }

        // 시도 횟수가 적으면 파랑에 가깝도록
        if (totalAttempts <= 2) {
          color = '#007bff';
        }

        const button = document.querySelector(`#sheet-selection button[data-sheet="${sheet}"]`);
        if(button) {
          button.style.backgroundColor = color;
        }
      });
    }

    function displaySheetSelection() {
      const selectionContainer = document.getElementById('sheet-selection');
      selectionContainer.innerHTML = "";
      sheetNames.forEach(sheet => {
        const button = document.createElement('button');
        button.textContent = sheet;
        button.setAttribute('data-sheet', sheet);
        button.onclick = () => fetchQuestions(sheet);
        selectionContainer.appendChild(button);
      });
      assignSheetButtonColors();
    }

    function populateBattleModeSelection() {
      const battleSelectionContainer = document.getElementById('battle-sheet-selection');
      battleSelectionContainer.innerHTML = "";
      sheetNames.forEach(sheet => {
        const div = document.createElement('div');
        div.classList.add('sheet-option');
        div.innerHTML = `
          <label>
            <input type="checkbox" value="${sheet}"> ${sheet}
          </label>
        `;
        battleSelectionContainer.appendChild(div);
      });
    }

    /************************************************
     * 문제 데이터 로드 (원래 로직 활용)
     ************************************************/
    async function fetchQuestions(sheetName) {
      const sheetNameElem = document.getElementById('sheet-name');
      const questionElem = document.getElementById('question');
      sheetNameElem.textContent = "불러오는 중...";
      questionElem.textContent = "불러오는 중...";

      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(sheetName)}?key=${apiKey}`;
        const response = await fetch(url);
        if(!response.ok) {
          sheetNameElem.textContent = `문제집 [${sheetName}] 로드 실패`;
          questionElem.textContent = "";
          return;
        }
        const data = await response.json();
        if(!data.values || data.values.length < 1) {
          sheetNameElem.textContent = `문제집 [${sheetName}]에 데이터가 없습니다.`;
          questionElem.textContent = "";
          return;
        }
        currentSheetName = sheetName;
        isBattleMode = false; 
        questions = processSheetData(data.values);
        if(randomOrder) {
          questions = shuffle(questions);
        }
        startQuiz();
      } catch(e) {
        console.error(e);
        sheetNameElem.textContent = `문제집 [${sheetName}] 로드 에러`;
        questionElem.textContent = "";
      }
    }

    async function startBattleMode() {
      const battleSelectionContainer = document.getElementById('battle-sheet-selection');
      const selectedSheets = Array.from(battleSelectionContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
      if(selectedSheets.length === 0) {
        alert("최소 1개 이상의 문제집을 선택하세요.");
        return;
      }

      let numQuestions = prompt("배틀 모드 문제 수를 입력하세요 (10~500):", "50");
      if (numQuestions === null) {
        // 사용자가 취소
        return;
      }
      numQuestions = parseInt(numQuestions);
      if (isNaN(numQuestions) || numQuestions < 10 || numQuestions > 500) {
        alert("10에서 500 사이의 올바른 숫자를 입력하세요.");
        return;
      }

      closeBattleModeSelection();

      const sheetSelectionContainer = document.getElementById('sheet-selection');
      sheetSelectionContainer.innerHTML = "<p>배틀 모드 문제를 불러오는 중...</p>";
      try {
        let allQuestions = [];
        for(const sheet of selectedSheets) {
          const sheetUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(sheet)}?key=${apiKey}`;
          const sheetResponse = await fetch(sheetUrl);
          if(sheetResponse.ok) {
            const sheetData = await sheetResponse.json();
            if(sheetData.values && sheetData.values.length >=1) {
              const processed = processSheetData(sheetData.values);
              allQuestions = allQuestions.concat(processed);
            }
          }
        }
        if(allQuestions.length === 0) {
          sheetSelectionContainer.innerHTML = "<p>배틀 모드 문제를 찾지 못했습니다.</p>";
          return;
        }
        if(allQuestions.length < numQuestions) {
          alert(`사용 가능한 문제는 ${allQuestions.length}개입니다. 전부 사용합니다.`);
          numQuestions = allQuestions.length;
        }
        currentSheetName = "배틀 모드 문제집";
        isBattleMode = true;
        questions = shuffle(allQuestions).slice(0, numQuestions);
        if(randomOrder) {
          questions = shuffle(questions);
        }
        startQuiz();
      } catch(e) {
        console.error(e);
        sheetSelectionContainer.innerHTML = "<p>배틀 모드 문제 불러오기 실패.</p>";
      }
    }

    function openBattleModeSelection() {
      document.getElementById('battle-mode-selection-container').style.display = 'flex';
    }

    function closeBattleModeSelection() {
      document.getElementById('battle-mode-selection-container').style.display = 'none';
    }

    function processSheetData(values) {
      return values.map((row, idx) => {
        let qText = row[1] ? row[1] : "";
        qText = qText.replace(/\u200B/g, '').trim(); // 제로폭스페이스 제거

        if (!qText) {
          const time = new Date().toLocaleString();
          const rowNumber = idx + 1;
          const colNumber = 2;
          logs.push({
            type: 'error',
            time: time,
            location: userLocation,
            detail: {
              message: "문제 문항이 비어있음",
              sheet: currentSheetName,
              row: rowNumber,
              col: colNumber,
              questionData: row
            }
          });
          console.log(`문제 문항이 없는 행: Sheet=${currentSheetName}, Row=${rowNumber}, Col=${colNumber}, 데이터:`, row);
        }
        const qImage = row[2] ? row[2].trim() : "";
        const qExplanation = row[7] ? row[7].trim() : ""; // H열 => 인덱스7
        return {
          question: qText || "문항 없음",
          image: qImage,
          answer: row[8] === "o" ? "⭕" : "❌", // I열 => 인덱스8
          explanation: qExplanation || ""
        };
      }).filter(q => q.question !== "문항 없음");
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random()*(i+1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function startQuiz() {
      currentQuestionIndex = 0;
      userAnswers = [];
      answerVisible = false;
      mistakeQuestions = [];
      elapsedTime = 0;
      clearCurrentExam();
      document.getElementById('container').style.display = 'none';
      document.getElementById('quiz-container').style.display = 'block';
      document.getElementById('sheet-name').innerText = `현재 문제집: ${currentSheetName}`;
      loadQuestion();
      startTimer();
    }

    function startQuizFromState() {
      document.getElementById('container').style.display = 'none';
      document.getElementById('quiz-container').style.display = 'block';
      document.getElementById('sheet-name').innerText = `현재 문제집: ${currentSheetName}`;
      loadQuestion();
      startTimer();
    }

    function loadQuestion() {
      const q = questions[currentQuestionIndex];
      const questionElem = document.getElementById('question');
      const imageContainer = document.getElementById('image');
      
      questionElem.textContent = "불러오는 중...";
      imageContainer.style.display='none';
      imageContainer.innerHTML = '';

      setTimeout(() => {
        questionElem.innerText = q.question;
        resetButtonHighlight();
        const ans = userAnswers[currentQuestionIndex];
        if(ans === '⭕') {
          document.getElementById('btn-correct').classList.add('highlight');
        } else if(ans === '❌') {
          document.getElementById('btn-wrong').classList.add('highlight');
        }
        updateRemainingQuestions();
      }, 200);

      if (q.image) {
        imageContainer.style.display='flex';
        imageContainer.innerText = "불러오는 중...";
        const img = new Image();
        img.src = q.image;
        img.onload = () => {
          imageContainer.innerHTML = '';
          imageContainer.appendChild(img);
        };
        img.onerror = () => {
          console.log("이미지 로드 실패:", q.image);
          imageContainer.innerHTML = '';
          imageContainer.style.display='none';
        }
      } else {
        imageContainer.style.display='none';
        imageContainer.innerHTML = '';
      }

      if (q.explanation) {
        document.getElementById('answer-display').innerText = "";
      } else {
        document.getElementById('answer-display').innerText = "";
      }
      saveCurrentExam();
    }

    function updateRemainingQuestions() {
      const remaining = questions.length - currentQuestionIndex - 1;
      document.getElementById('remaining-questions').innerText = `남은 문제 수: ${remaining}`;
    }

    function selectAnswer(answer) {
      userAnswers[currentQuestionIndex] = answer;
      resetButtonHighlight();
      if (answer === '⭕') document.getElementById('btn-correct').classList.add('highlight');
      if (answer === '❌') document.getElementById('btn-wrong').classList.add('highlight');
      saveCurrentExam();

      if(autoNext) {
        setTimeout(() => {
          if (currentQuestionIndex < questions.length - 1) {
            currentQuestionIndex++;
            loadQuestion();
          } else {
            alert('마지막 문제입니다. 제출을 진행하세요.');
          }
        }, 300);
      }

      // 마지막 문제이며 자동 넘김이면 제출 안내
      if(autoNext && currentQuestionIndex === questions.length -1) {
        setTimeout(() => {
          submitQuiz();
        }, 500);
      }
    }

    function resetButtonHighlight() {
      document.getElementById('btn-correct').classList.remove('highlight');
      document.getElementById('btn-wrong').classList.remove('highlight');
    }

    function toggleAnswer() {
      const correctAnswer = questions[currentQuestionIndex].answer;
      const explanation = questions[currentQuestionIndex].explanation;
      if (answerVisible) {
        document.getElementById('answer-display').innerText = "";
      } else {
        if (explanation) {
          document.getElementById('answer-display').innerText = `정답: ${correctAnswer}\n해설: ${explanation}`;
        } else {
          document.getElementById('answer-display').innerText = `정답: ${correctAnswer}`;
        }
      }
      answerVisible = !answerVisible;
    }

    function nextQuestion() {
      if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        loadQuestion();
      } else {
        alert('마지막 문제입니다. 제출을 진행하세요.');
      }
    }

    function previousQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        loadQuestion();
      }
    }

    function allQuestionsAnswered() {
      return questions.every((q, i) => {
        const ans = userAnswers[i];
        return ans === '⭕' || ans === '❌';
      });
    }

    function submitQuiz() {
      let confirmation = true;
      if (!allQuestionsAnswered()) {
        confirmation = confirm("아직 답하지 않은 문제가 있습니다. 정말 제출하시겠습니까?");
      }
      if (!confirmation) {
        return;
      }

      stopTimer(); 
      quizEndTime = new Date(); 
      const timeSpentMs = quizEndTime - quizStartTime + elapsedTime;
      const timeSpentMinutes = Math.floor(timeSpentMs / 60000);
      const timeSpentSeconds = Math.floor((timeSpentMs % 60000) / 1000);
      const timeSpentFormatted = `${timeSpentMinutes}분${timeSpentSeconds}초`;

      let incorrectCount = 0;
      let correctCount = 0;
      let unansweredCount = 0;
      let mistakesObj = loadMistakesFromCache();
      mistakeQuestions = [];

      const totalQuestions = questions.length;
      const scorePerQuestion = 100 / totalQuestions;
      let totalScore = 0;

      questions.forEach((q, index) => {
        const userAnswer = userAnswers[index];
        if (userAnswer === undefined) {
          unansweredCount++;
        } else if (userAnswer === q.answer) {
          correctCount++;
          totalScore += scorePerQuestion;
        } else {
          incorrectCount++;
          const key = q.question + '||' + q.answer + '||' + q.image + '||' + q.explanation;
          if (mistakesObj[key]) {
            mistakesObj[key].count += 1;
            mistakesObj[key].userAnswer = userAnswer;
            if(!mistakesObj[key].sheetName) {
              mistakesObj[key].sheetName = currentSheetName;
            }
          } else {
            mistakesObj[key] = {
              question: q.question,
              image: q.image,
              answer: q.answer,
              explanation: q.explanation,
              count: 1,
              userAnswer: userAnswer,
              sheetName: currentSheetName
            };
          }

          mistakeQuestions.push({
            question: q.question,
            image: q.image,
            answer: q.answer,
            explanation: q.explanation,
            userAnswer: userAnswer,
            sheetName: currentSheetName
          });
        }
      });

      totalScore = Math.floor(totalScore);
      if(totalScore > 100) totalScore = 100;

      saveMistakesToCache(mistakesObj);
      clearCurrentExam(); 

      let scoreMessage = "";
      let scoreClass = "";
      if(totalScore === 100) {
        scoreMessage = "만점! 대단합니다!";
        scoreClass = "score-excellent";
      } else if(totalScore >= 90) {
        scoreMessage = "합격 수준! 조금만 더 화이팅!";
        scoreClass = "score-good";
      } else {
        scoreMessage = "불합격... 더 연습이 필요합니다.";
        scoreClass = "score-bad";
      }

      const answeredQuestions = correctCount + incorrectCount;
      const completionPercentage = Math.floor((answeredQuestions / totalQuestions) * 100);

      const progressBar = document.getElementById('progress-bar');
      progressBar.style.width = `${completionPercentage}%`;
      progressBar.innerText = `${completionPercentage}%`;
      progressBar.style.backgroundColor = completionPercentage >= 90 ? '#28a745' :
                                         completionPercentage >= 70 ? '#ffc107' :
                                         '#dc3545';

      document.getElementById('quiz-container').style.display = 'none';
      document.getElementById('result-container').style.display = 'block';
      const scoreElem = document.getElementById('score');
      scoreElem.innerText = `점수: ${totalScore}점 - ${scoreMessage}`;
      scoreElem.className = scoreClass; 
      document.getElementById('mistake-count').innerText = `틀린 문제: ${incorrectCount}개`;
      document.getElementById('correct-count').innerText = `맞힌 문제: ${correctCount}개`;
      document.getElementById('unanswered-count').innerText = `미답: ${unansweredCount}개`;
      document.getElementById('completion-status').innerText = `완료도: ${answeredQuestions}/${totalQuestions}`;

      const history = loadQuizHistory();
      history.push({
        dateTime: new Date().toLocaleString(),
        sheetName: currentSheetName,
        wrongCount: incorrectCount,
        correctCount: correctCount,
        unansweredCount: unansweredCount,
        timeSpent: timeSpentFormatted,
        answered: answeredQuestions,
        total: totalQuestions,
        score: totalScore
      });
      saveQuizHistory(history);

      logs.push({
        type: 'quiz',
        time: new Date().toLocaleString(),
        location: userLocation,
        detail: {
          sheetName: currentSheetName,
          wrongCount: incorrectCount,
          correctCount: correctCount,
          unansweredCount: unansweredCount,
          timeSpent: timeSpentFormatted,
          answered: answeredQuestions,
          total: totalQuestions,
          score: totalScore
        }
      });
    }

    function pauseExam() {
      stopTimer();
      const now = new Date();
      elapsedTime += now - quizStartTime;
      saveCurrentExam();
      alert("시험 진행 상황이 저장되었습니다. 다음에 계속할 수 있습니다.");
      document.getElementById('quiz-container').style.display = 'none';
      document.getElementById('container').style.display = 'block';
      if(loadCurrentExam()) {
        const continueExamBtn = document.getElementById('continue-exam-btn');
        if (continueExamBtn) {
          continueExamBtn.style.display = 'inline-block';
        }
      }
    }

    function resetQuiz() {
      stopTimer();
      document.getElementById('quiz-container').style.display = 'none';
      document.getElementById('result-container').style.display = 'none';
      document.getElementById('container').style.display = 'block';
      document.getElementById('mistake-review-container').style.display='none';
      document.getElementById('current-mistakes-container').style.display='none';
      document.getElementById('console-logs-container').style.display='none';
      document.getElementById('update-logs-container').style.display='none';
      document.getElementById('function-intro-container').style.display='none';
      document.getElementById('summary-container').style.display='none';
      isBattleMode = false;
      fetchSheetNames();
      if(loadCurrentExam()) {
        const continueExamBtn = document.getElementById('continue-exam-btn');
        if (continueExamBtn) {
          continueExamBtn.style.display = 'inline-block';
        }
      } else {
        const continueExamBtn = document.getElementById('continue-exam-btn');
        if (continueExamBtn) {
          continueExamBtn.style.display = 'none';
        }
      }
    }

    function viewMistakes() {
      document.getElementById('result-container').style.display = 'none';
      document.getElementById('current-mistakes-container').style.display = 'block';
      const mistakeContainer = document.getElementById('current-mistakes-list');
      mistakeContainer.innerHTML = '';

      if (mistakeQuestions.length === 0) {
        mistakeContainer.innerHTML = "<p>이번 시험에서 틀린 문제가 없습니다.</p>";
        return;
      }

      mistakeQuestions.forEach((item, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.style.paddingBottom = "10px";

        let imgHTML = '';
        if (item.image) {
          imgHTML = `<div><img src="${item.image}" alt="문제 이미지" style="max-width:100%;max-height:150px;object-fit:contain;margin-top:10px;"></div>`;
        }

        let explanationHTML = '';
        if (item.explanation) {
          explanationHTML = `<div><strong>해설:</strong> ${item.explanation}</div>`;
        }

        questionDiv.innerHTML =
          `<div><strong>문제집:</strong> ${item.sheetName || "정보 없음"}</div>
           <div><strong>문제 ${index + 1}:</strong> ${item.question}</div>
           ${imgHTML}
           <div><strong>나의 답안:</strong> ${item.userAnswer}</div>
           <div><strong>정답:</strong> ${item.answer}</div>
           ${explanationHTML}`;
        mistakeContainer.appendChild(questionDiv);
      });
    }

    function startMistakeReview() {
      const mistakesObj = loadMistakesFromCache();
      const keys = Object.keys(mistakesObj);
      if (keys.length === 0) {
        alert("저장된 오답 노트가 없습니다.");
        return;
      }

      stopTimer();
      document.getElementById('container').style.display = 'none';
      document.getElementById('quiz-container').style.display = 'none';
      document.getElementById('result-container').style.display = 'none';
      document.getElementById('current-mistakes-container').style.display = 'none';
      document.getElementById('console-logs-container').style.display = 'none';
      document.getElementById('update-logs-container').style.display = 'none';
      document.getElementById('function-intro-container').style.display = 'none';
      document.getElementById('summary-container').style.display = 'none';
      document.getElementById('mistake-review-container').style.display = 'block';

      const mistakeContainer = document.getElementById('mistake-questions');
      mistakeContainer.innerHTML = '';

      keys.forEach((key, index) => {
        const item = mistakesObj[key];
        const uAnswer = item.userAnswer || "정보 없음";
        const cCount = (item.count !== undefined) ? item.count : "정보 없음";
        const sheetNameDisplay = item.sheetName || "정보 없음";

        const questionDiv = document.createElement('div');

        let imgHTML = '';
        if (item.image) {
          imgHTML = `<div><img src="${item.image}" alt="문제 이미지" style="max-width:100%;max-height:150px;object-fit:contain;margin-top:10px;"></div>`;
        }

        let explanationHTML = '';
        if (item.explanation) {
          explanationHTML = `<div><strong>해설:</strong> ${item.explanation}</div>`;
        }

        questionDiv.innerHTML =
          `<div><strong>문제집:</strong> ${sheetNameDisplay}</div>
           <div><strong>문제 ${index + 1}:</strong> ${item.question}</div>
           ${imgHTML}
           <div><strong>최근 오답:</strong> ${uAnswer}</div>
           <div><strong>정답:</strong> ${item.answer}</div>
           ${explanationHTML}
           <div><strong>누적 오답 횟수:</strong> ${cCount}</div>`;
        mistakeContainer.appendChild(questionDiv);
      });
    }

    function showFunctionIntro() {
      document.getElementById('container').style.display='none';
      document.getElementById('quiz-container').style.display='none';
      document.getElementById('result-container').style.display='none';
      document.getElementById('mistake-review-container').style.display='none';
      document.getElementById('current-mistakes-container').style.display='none';
      document.getElementById('console-logs-container').style.display='none';
      document.getElementById('update-logs-container').style.display='none';
      document.getElementById('summary-container').style.display='none';
      document.getElementById('function-intro-container').style.display='block';
    }

    function showSummary() {
      document.getElementById('container').style.display='none';
      document.getElementById('quiz-container').style.display='none';
      document.getElementById('result-container').style.display='none';
      document.getElementById('mistake-review-container').style.display='none';
      document.getElementById('current-mistakes-container').style.display='none';
      document.getElementById('console-logs-container').style.display='none';
      document.getElementById('update-logs-container').style.display='none';
      document.getElementById('function-intro-container').style.display='none';
      document.getElementById('summary-container').style.display='block';

      const summaryContent = document.getElementById('summary-content');
      summaryContent.innerHTML = "불러오는 중...";

      const history = loadQuizHistory();
      if(history.length === 0) {
        summaryContent.innerHTML = "<p>시험 기록이 없습니다.</p>";
        return;
      }

      // 문제집별로 요약
      const summaryBySheet = {};
      history.forEach(entry => {
        if(!summaryBySheet[entry.sheetName]) {
          summaryBySheet[entry.sheetName] = {
            attempts: 0,
            totalWrong: 0,
            totalCorrect: 0,
            totalUnanswered: 0,
            totalTime: 0,
            lastCompletionTime: "",
            lastCompletion: {answered: 0, total: 0},
            scores: [],
            individualPerformances: []
          };
        }
        summaryBySheet[entry.sheetName].attempts += 1;
        summaryBySheet[entry.sheetName].totalWrong += entry.wrongCount;
        summaryBySheet[entry.sheetName].totalCorrect += entry.correctCount;
        summaryBySheet[entry.sheetName].totalUnanswered += entry.unansweredCount;
        const timeParts = entry.timeSpent.match(/(\d+)분(\d+)초/);
        let totalSeconds = 0;
        if(timeParts) {
          totalSeconds = parseInt(timeParts[1]) * 60 + parseInt(timeParts[2]);
        }
        summaryBySheet[entry.sheetName].totalTime += totalSeconds;
        summaryBySheet[entry.sheetName].lastCompletionTime = entry.dateTime;
        summaryBySheet[entry.sheetName].lastCompletion = {answered: entry.answered, total: entry.total};
        summaryBySheet[entry.sheetName].scores.push(entry.score);
        summaryBySheet[entry.sheetName].individualPerformances.push({
          dateTime: entry.dateTime,
          wrongCount: entry.wrongCount,
          correctCount: entry.correctCount,
          unansweredCount: entry.unansweredCount,
          timeSpent: entry.timeSpent,
          answered: entry.answered,
          total: entry.total,
          score: entry.score
        });
      });

      let html = "";
      for(const sheet in summaryBySheet) {
        const sheetData = summaryBySheet[sheet];
        const averageWrong = (sheetData.attempts > 0) ? (sheetData.totalWrong / sheetData.attempts).toFixed(2) : 0;
        const averageCorrect = (sheetData.attempts > 0) ? (sheetData.totalCorrect / sheetData.attempts).toFixed(2) : 0;
        const averageUnanswered = (sheetData.attempts > 0) ? (sheetData.totalUnanswered / sheetData.attempts).toFixed(2) : 0;
        const averageScore = (sheetData.scores.reduce((a, b) => a + b, 0) / sheetData.attempts).toFixed(2);

        // 시간(초) 단위 계산
        const avgTotalSec = sheetData.totalTime / sheetData.attempts;
        const avgMin = Math.floor(avgTotalSec / 60);
        const avgSec = Math.floor(avgTotalSec % 60);
        const averageTimeFormatted = `${avgMin}분${avgSec}초`;

        html += `<div class="summary-sheet">
                  <h3>문제집: ${sheet}</h3>
                  <table>
                    <tr>
                      <th>총 응시 횟수</th>
                      <th>평균 오답 수</th>
                      <th>평균 정답 수</th>
                      <th>평균 미답 수</th>
                      <th>평균 점수</th>
                      <th>평균 소요 시간</th>
                      <th>마지막 시험 일시</th>
                      <th>마지막 시험 진행도</th>
                    </tr>
                    <tr>
                      <td>${sheetData.attempts}</td>
                      <td>${averageWrong}</td>
                      <td>${averageCorrect}</td>
                      <td>${averageUnanswered}</td>
                      <td>${averageScore}</td>
                      <td>${averageTimeFormatted}</td>
                      <td>${sheetData.lastCompletionTime}</td>
                      <td>${sheetData.lastCompletion.answered}/${sheetData.lastCompletion.total}</td>
                    </tr>
                  </table>
                  <h4>개별 시험 기록:</h4>
                  <table>
                    <tr>
                      <th>응시 일시</th>
                      <th>오답 수</th>
                      <th>정답 수</th>
                      <th>미답 수</th>
                      <th>소요 시간</th>
                      <th>점수</th>
                      <th>답안 수/전체</th>
                    </tr>`;
        sheetData.individualPerformances.forEach(perf => {
          html += `<tr>
                    <td>${perf.dateTime}</td>
                    <td>${perf.wrongCount}</td>
                    <td>${perf.correctCount}</td>
                    <td>${perf.unansweredCount}</td>
                    <td>${perf.timeSpent}</td>
                    <td>${perf.score}</td>
                    <td>${perf.answered}/${perf.total}</td>
                  </tr>`;
        });
        html += `</table>
                </div>`;
      }

      summaryContent.innerHTML = html;
    }

    function showScore() {
      document.getElementById('current-mistakes-container').style.display = 'none';
      document.getElementById('result-container').style.display = 'block';
    }

    function clearAllHistory() {
      const confirmClear = confirm("기록을 삭제하면 오답 노트, 미완료 시험 기록 등이 모두 삭제됩니다. 정말 진행하시겠습니까?");
      if(confirmClear) {
        localStorage.clear();
        alert("기록이 삭제되었습니다.");
        resetQuiz();
      }
    }

    function showUpdateLogs() {
      document.getElementById('container').style.display='none';
      document.getElementById('quiz-container').style.display='none';
      document.getElementById('result-container').style.display='none';
      document.getElementById('mistake-review-container').style.display='none';
      document.getElementById('current-mistakes-container').style.display='none';
      document.getElementById('console-logs-container').style.display='none';
      document.getElementById('function-intro-container').style.display='none';
      document.getElementById('summary-container').style.display='none';
      document.getElementById('update-logs-container').style.display='block';
    }

    async function viewConsoleLogs() {
      const password = prompt("콘솔 로그를 확인하기 위한 비밀번호를 입력하세요:");
      if (password === "Aa123456") {
        try {
          await recordLogsToSheet();
        } catch(e) {
          console.error("Google Sheet에 로그 쓰기 실패:", e);
        }
        showConsoleLogsFromSheet();
      } else {
        alert("비밀번호가 올바르지 않습니다!");
      }
    }

    async function recordLogsToSheet() {
      if(logs.length === 0) {
        return;
      }

      const values = logs.map(log => {
        if (log.type === 'access') {
          return [
            'access',
            log.time || '',
            log.location || '',
            log.detail.device || '',
            log.detail.ip || '',
            'N/A',
            'N/A',
            'N/A'
          ];
        } else if (log.type === 'error') {
          return [
            'error',
            log.time || '',
            log.location || '',
            log.detail.message || '',
            log.detail.sheet || '',
            log.detail.row || '',
            log.detail.col || '',
            JSON.stringify(log.detail.questionData || '')
          ];
        } else if (log.type === 'quiz') {
          return [
            'quiz',
            log.time || '',
            log.location || '',
            `Sheet: ${log.detail.sheetName}, Wrong: ${log.detail.wrongCount}, Correct: ${log.detail.correctCount}, Unanswered: ${log.detail.unansweredCount}, Time: ${log.detail.timeSpent}, Score: ${log.detail.score}`,
            'N/A',
            'N/A',
            'N/A',
            'N/A'
          ];
        }
      });

      const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/Console!A1:append?valueInputOption=RAW&key=${apiKey}`;
      const body = {values: values};
      await fetch(url, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(body)
      });

      logs = [];
    }

    async function showConsoleLogsFromSheet() {
      document.getElementById('container').style.display='none';
      document.getElementById('quiz-container').style.display='none';
      document.getElementById('result-container').style.display='none';
      document.getElementById('mistake-review-container').style.display='none';
      document.getElementById('current-mistakes-container').style.display='none';
      document.getElementById('update-logs-container').style.display='none';
      document.getElementById('function-intro-container').style.display='none';
      document.getElementById('summary-container').style.display='none';
      document.getElementById('console-logs-container').style.display='block';

      const consoleLogsContent = document.getElementById('console-logs-content');
      consoleLogsContent.textContent = "불러오는 중...";

      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/Console!A:Z?key=${apiKey}`;
        const response = await fetch(url);
        if(!response.ok) {
          consoleLogsContent.innerHTML = "<p>콘솔 로그 불러오기에 실패했습니다.</p>";
          return;
        }
        const data = await response.json();
        if(!data.values || data.values.length <= 1) {
          consoleLogsContent.innerHTML = "<p>아직 로그 기록이 없습니다.</p>";
          return;
        }

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const headers = ["타입","시간","위치","장치/메시지","IP","Row","Col","QuestionData"];
        headers.forEach(h => {
          const th = document.createElement('th');
          th.textContent = h;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        data.values.slice(1).forEach((rowArr) => {
          const tr = document.createElement('tr');
          headers.forEach((h, i) => {
            const td = document.createElement('td');
            td.textContent = rowArr[i] || "";
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        consoleLogsContent.innerHTML = '';
        consoleLogsContent.appendChild(table);

      } catch(e) {
        console.error(e);
        consoleLogsContent.innerHTML = "<p>로그를 불러오는 중 오류가 발생했습니다.</p>";
      }
    }

    function continueExam() {
      const exam = loadCurrentExam();
      if(!exam) {
        alert("이어 진행할 시험 기록이 없습니다.");
        return;
      }
      const {
        sheetName,
        currentQuestionIndex: idx,
        userAnswers: ua,
        questions: qs,
        randomOrder: ro,
        autoNext: an,
        elapsedTime: et,
        isBattleMode: bm
      } = exam;

      const total = qs.length;
      const progress = idx + 1;
      const confirmContinue = confirm(`이전에 진행하던 시험이 있습니다. (문제집: ${sheetName}, 진도: ${progress}/${total})\n계속하시겠습니까?`);
      if(confirmContinue) {
        currentSheetName = sheetName;
        currentQuestionIndex = idx;
        userAnswers = ua;
        questions = qs;
        randomOrder = ro;
        autoNext = an;
        isBattleMode = bm;
        elapsedTime = et || 0;
        const randomCheckbox = document.getElementById('random-checkbox');
        if (randomCheckbox) {
          randomCheckbox.checked = randomOrder;
        }
        const autoNextCheckbox = document.getElementById('autonext-checkbox');
        if (autoNextCheckbox) {
          autoNextCheckbox.checked = autoNext;
        }
        startQuizFromState();
      } else {
        clearCurrentExam();
      }
    }

    function startTimer() {
      const timerElem = document.getElementById('timer');
      quizStartTime = new Date();
      timerInterval = setInterval(() => {
        const now = new Date();
        const elapsed = now - quizStartTime + elapsedTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        timerElem.innerText = `시간: ${String(minutes).padStart(2, '0')}분${String(seconds).padStart(2, '0')}초`;
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timerInterval);
    }

    // QR코드 이미지를 클릭했을 때 열기
    function triggerScan() {
      const qrImage = document.querySelector('#initial-message img');
      if(qrImage) {
        window.open(qrImage.src, '_blank');
      }
    }

    /*****************************
     * KR 시트에서 초기 메시지 불러오기 (KR!B1:B5)
     *****************************/
    async function loadInitialMessages() {
      const initialMessageContainer = document.getElementById('initial-message');
      initialMessageContainer.innerHTML = "<p>불러오는 중...</p>";

      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${systemSpreadsheetId}/values/KR!B1:B5?key=${systemApiKey}`;
        const response = await fetch(url);
        if(!response.ok) {
          initialMessageContainer.innerHTML = "<p>초기 메시지를 불러오지 못했습니다.</p>";
          return;
        }
        const data = await response.json();
        if(!data.values || data.values.length === 0) {
          initialMessageContainer.innerHTML = "<p>메시지가 없습니다.</p>";
          return;
        }

        // 기존 내용 초기화
        initialMessageContainer.innerHTML = "";

        // B1~B4는 텍스트
        data.values.slice(0,4).forEach((row) => {
          const message = row[0] ? row[0].trim() : "";
          if(message) {
            const p = document.createElement('p');
            p.textContent = message;
            initialMessageContainer.appendChild(p);
          }
        });

        // B5는 QR 이미지 링크
        if(data.values.length >= 5) {
          const qrUrl = data.values[4][0] ? data.values[4][0].trim() : "";
          if(qrUrl) {
            const img = document.createElement('img');
            img.src = qrUrl;
            img.alt = "커뮤니티 참여 QR코드";
            img.onclick = triggerScan;
            initialMessageContainer.appendChild(img);
          }
        }

      } catch(e) {
        console.error("초기 메시지 로드 에러:", e);
        initialMessageContainer.innerHTML = "<p>초기 메시지를 불러오는 중 오류가 발생했습니다.</p>";
      }
    }

    /*****************************
     * KR 시트에서 업데이트 로그 불러오기 (KR!C1:D)
     *****************************/
    async function loadUpdateLogs() {
      const updateLogsContainer = document.getElementById('update-logs-list');
      updateLogsContainer.innerHTML = "<p>불러오는 중...</p>";

      try {
        // KR!C 열: 날짜, KR!D 열: 업데이트 내용
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${systemSpreadsheetId}/values/KR!C1:D?key=${systemApiKey}`;
        const response = await fetch(url);
        if(!response.ok) {
          updateLogsContainer.innerHTML = "<p>업데이트 로그를 불러오지 못했습니다.</p>";
          return;
        }
        const data = await response.json();
        if(!data.values || data.values.length < 2 ) {
          updateLogsContainer.innerHTML = "<p>업데이트 로그가 없습니다.</p>";
          return;
        }

        updateLogsContainer.innerHTML = "";
        const table = document.createElement('table');

        // 테이블 헤더
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const headers = ["날짜", "업데이트 내용"];
        headers.forEach(h => {
          const th = document.createElement('th');
          th.textContent = h;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        data.values.slice(1).forEach((rowArr) => {
          const cDate = rowArr[0] ? rowArr[0].trim() : "";
          const cUpdate = rowArr[1] ? rowArr[1].trim() : "";
          if(cDate || cUpdate) {
            const tr = document.createElement('tr');
            const tdDate = document.createElement('td');
            tdDate.textContent = cDate;
            const tdContent = document.createElement('td');
            tdContent.textContent = cUpdate;
            tr.appendChild(tdDate);
            tr.appendChild(tdContent);
            tbody.appendChild(tr);
          }
        });

        if(tbody.children.length === 0) {
          updateLogsContainer.innerHTML = "<p>업데이트 로그가 없습니다.</p>";
        } else {
          table.appendChild(tbody);
          updateLogsContainer.appendChild(table);
        }

      } catch(e) {
        console.error("업데이트 로그 로드 실패:", e);
        updateLogsContainer.innerHTML = "<p>업데이트 로그를 불러오는 중 오류가 발생했습니다.</p>";
      }
    }

    /*****************************
     * KR 시트에서 기능 소개 불러오기 (KR!E1:G)
     *****************************/
    async function loadFunctionIntro() {
      const functionIntroContainer = document.getElementById('function-intro-content');
      functionIntroContainer.innerHTML = "<p>불러오는 중...</p>";

      try {
        // KR!E 열: 기능명, KR!F 열: 기능 설명, KR!G 열: 비고
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${systemSpreadsheetId}/values/KR!E1:G?key=${systemApiKey}`;
        const response = await fetch(url);
        if(!response.ok) {
          functionIntroContainer.innerHTML = "<p>기능 소개를 불러오지 못했습니다.</p>";
          return;
        }
        const data = await response.json();
        if(!data.values || data.values.length < 2 ) {
          functionIntroContainer.innerHTML = "<p>기능 소개 내용이 없습니다.</p>";
          return;
        }

        functionIntroContainer.innerHTML = "";
        const table = document.createElement('table');

        // 테이블 헤더 (3열)
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const headers = ["기능명","기능 설명","비고"];
        headers.forEach(h => {
          const th = document.createElement('th');
          th.textContent = h;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        data.values.slice(1).forEach((rowArr) => {
          const featureName = rowArr[0] ? rowArr[0].trim() : "";
          const featureDesc = rowArr[1] ? rowArr[1].trim() : "";
          const remarks = rowArr[2] ? rowArr[2].trim() : "";

          if(featureName || featureDesc || remarks) {
            const tr = document.createElement('tr');
            const tdName = document.createElement('td');
            tdName.textContent = featureName;
            const tdDesc = document.createElement('td');
            tdDesc.textContent = featureDesc;
            const tdRemarks = document.createElement('td');
            tdRemarks.textContent = remarks;
            tr.appendChild(tdName);
            tr.appendChild(tdDesc);
            tr.appendChild(tdRemarks);
            tbody.appendChild(tr);
          }
        });

        if(tbody.children.length === 0) {
          functionIntroContainer.innerHTML = "<p>기능 소개 내용이 없습니다.</p>";
        } else {
          table.appendChild(tbody);
          functionIntroContainer.appendChild(table);
        }

      } catch(e) {
        console.error("기능 소개 로드 실패:", e);
        functionIntroContainer.innerHTML = "<p>기능 소개를 불러오는 중 오류가 발생했습니다.</p>";
      }
    }
  </script>
</body>
</html>
